# Story 4.3: การตั้งค่าสำหรับ Production และการจัดการสภาพแวดล้อม

## สถานะ

แบบร่าง

## Story

**ในฐานะ** DevOps engineer
**ฉันต้องการ** การตั้งค่าและการติดตั้งที่พร้อมสำหรับ Production
**เพื่อที่จะ** สามารถ Deploy บริการได้อย่างปลอดภัยในสภาพแวดล้อมต่างๆ

## เกณฑ์การยอมรับ

1.  มีไฟล์การตั้งค่าที่แยกตามสภาพแวดล้อมสำหรับ Development, Staging และ Production
2.  ข้อมูลการตั้งค่าที่ละเอียดอ่อน (เช่น URL ฐานข้อมูล, ข้อมูล MinIO) ต้องดึงมาจาก Environment Variable
3.  อิมเมจ Docker ต้องได้รับการปรับให้เหมาะสมสำหรับ Production พร้อมแนวปฏิบัติด้านความปลอดภัยที่เหมาะสม
4.  Endpoint สำหรับการตรวจสอบสถานะระบบ (Health Check) ต้องให้รายละเอียดสถานะของ Dependency ทั้งหมด (ฐานข้อมูล, MinIO, Redis)
5.  มีการจัดการการปิดระบบอย่างนุ่มนวล (Graceful Shutdown) สำหรับระบบจัดการ Container
6.  การตั้งค่าการ Logging ต้องเหมาะสมสำหรับการตรวจสอบและ Debug ใน Production
7.  มีการตั้งค่า Header ด้านความปลอดภัย (CORS, Security Middleware) สำหรับการติดตั้งใน Production
8.  เอกสารประกอบต้องรวมคู่มือการติดตั้งพร้อมการอ้างอิงถึง Environment Variable

## งาน / งานย่อย

  - [ ] สร้างระบบการตั้งค่าเฉพาะสภาพแวดล้อม (AC: 1, 2)
      - [ ] สร้างไฟล์ `src/shared/config/env.ts` พร้อมการตรวจสอบ Environment Variable ที่ครอบคลุม
      - [ ] สร้าง Configuration Profile สำหรับสภาพแวดล้อม Development, Staging และ Production
      - [ ] เพิ่มการตรวจสอบ Environment Variable พร้อมระบุว่า Field ใดจำเป็นหรือเป็นทางเลือก
      - [ ] สร้างไฟล์ `.env.example` ที่มี Environment Variable ที่จำเป็นทั้งหมดพร้อมเอกสารประกอบ
      - [ ] สร้างระบบการโหลดการตั้งค่าพร้อมค่าเริ่มต้นสำหรับสภาพแวดล้อม Development
      - [ ] ตรวจสอบให้แน่ใจว่าการเข้าถึงการตั้งค่าที่ละเอียดอ่อนทำได้ผ่าน Config Module แบบรวมศูนย์เท่านั้น
  - [ ] จัดการ Environment Variable อย่างปลอดภัย (AC: 2)
      - [ ] อัปเดตการตั้งค่าฐานข้อมูลให้ใช้ Environment Variable `DATABASE_URL`
      - [ ] อัปเดตการตั้งค่า MinIO ให้ใช้ Environment Variable `MINIO_*` จาก Config
      - [ ] อัปเดตการตั้งค่า Redis ให้ใช้ Environment Variable `REDIS_URL`
      - [ ] สร้างระบบการตรวจสอบการตั้งค่าเพื่อให้แน่ใจว่า Secret ที่จำเป็นทั้งหมดมีอยู่ครบ
      - [ ] ปฏิบัติตามมาตรฐานความปลอดภัยที่ป้องกันไม่ให้ Secret ไปอยู่ใน Log หรือข้อความแจ้งข้อผิดพลาด
      - [ ] จัดทำเอกสารข้อกำหนด Environment Variable สำหรับสภาพแวดล้อมการติดตั้ง
  - [ ] ปรับอิมเมจ Docker สำหรับ Production (AC: 3)
      - [ ] อัปเดต `Dockerfile` ด้วย Multi-stage Build เพื่ออิมเมจ Production ที่เหมาะสมที่สุด
      - [ ] ใช้สิทธิ์ผู้ใช้และแนวทางปฏิบัติด้านความปลอดภัยที่เหมาะสมใน Container
      - [ ] ปรับขนาดอิมเมจและเวลาเริ่มต้นให้เหมาะสมสำหรับการติดตั้งใน Production
      - [ ] เพิ่มการตั้งค่า Health Check ที่เหมาะสมใน `Dockerfile`
      - [ ] ตรวจสอบให้แน่ใจว่า Container ทำงานในฐานะ Non-root User ที่มีสิทธิ์น้อยที่สุด
      - [ ] ทำตามแนวทางปฏิบัติที่ดีที่สุดด้านความปลอดภัยของ Docker สำหรับ Production
  - [ ] ปรับปรุง Endpoint Health Check ด้วยการตรวจสอบ Dependency (AC: 4)
      - [ ] อัปเดตไฟล์ `src/features/health/health.service.ts` ด้วยการตรวจสอบ Dependency ที่ครอบคลุม
      - [ ] เพิ่มการตรวจสอบการเชื่อมต่อฐานข้อมูลพร้อมสถานะ Connection Pool
      - [ ] เพิ่มการตรวจสอบการเชื่อมต่อบริการ MinIO พร้อมการยืนยันการเข้าถึง Bucket
      - [ ] เพิ่มการตรวจสอบการเชื่อมต่อ Redis (หากมีการตั้งค่า Redis)
      - [ ] สร้างการตอบกลับ Health Check พร้อมรายละเอียดสถานะของแต่ละ Dependency
      - [ ] คืนค่ารหัสสถานะ HTTP ที่เหมาะสมตามสถานะโดยรวมของบริการ
      - [ ] ใส่ข้อมูลเวอร์ชันและ Uptime ของบริการในการตอบกลับ Health Check
  - [ ] จัดการการปิดระบบอย่างนุ่มนวล (AC: 5)
      - [ ] เพิ่มการจัดการ Signal ใน `src/index.ts` สำหรับ `SIGTERM` และ `SIGINT`
      - [ ] จัดการการระบาย Connection ที่ยังคงทำงานอยู่อย่างนุ่มนวล
      - [ ] ปิดการเชื่อมต่อฐานข้อมูลอย่างสะอาดระหว่างการปิดระบบ
      - [ ] ปิดการเชื่อมต่อ MinIO และ Redis ระหว่างการปิดระบบ
      - [ ] เพิ่มการตั้งค่า Timeout สำหรับการปิดระบบในระบบจัดการ Container
      - [ ] ตรวจสอบให้แน่ใจว่ามีการจัดการการอัปโหลดไฟล์ที่ค้างอยู่อย่างเหมาะสมระหว่างการปิดระบบ
  - [ ] ตั้งค่าระบบ Logging สำหรับ Production (AC: 6)
      - [ ] อัปเดตการตั้งค่า Logging ใน Config ที่แชร์สำหรับสภาพแวดล้อม Production
      - [ ] ตั้งค่า Pino ด้วยระดับ Log ที่เหมาะสมสำหรับการตรวจสอบใน Production
      - [ ] ใช้ Structured Logging ที่มี Correlation ID สำหรับการ Debug
      - [ ] เพิ่มบริบทของบริการ (ชื่อ, เวอร์ชัน, สภาพแวดล้อม) ใน Log ทั้งหมด
      - [ ] ตั้งค่าการหมุนเวียน Log (Log Rotation) และนโยบายการเก็บรักษา Log สำหรับ Production
      - [ ] ตรวจสอบให้แน่ใจว่า Log เป็นไปตามมาตรฐานความปลอดภัยโดยไม่มีการเปิดเผยข้อมูลที่ละเอียดอ่อน
  - [ ] ตั้งค่า Security Header และ CORS สำหรับ Production (AC: 7)
      - [ ] อัปเดตการตั้งค่า CORS สำหรับ Domain ของ Production ใน Config เฉพาะสภาพแวดล้อม
      - [ ] สร้าง Middleware สำหรับ Security Header เพื่อตอบสนองความต้องการด้านความปลอดภัยของ Production
      - [ ] ตั้งค่า Header สำหรับ Rate Limiting และนโยบายความปลอดภัย
      - [ ] ตรวจสอบให้แน่ใจว่ามีการตั้งค่าเฉพาะ HTTPS สำหรับสภาพแวดล้อม Production
      - [ ] เพิ่มการตั้งค่า Security Middleware ตามสภาพแวดล้อมการติดตั้ง
      - [ ] ทดสอบการตั้งค่าความปลอดภัยด้วยสภาพแวดล้อมที่เหมือน Production
  - [ ] สร้างเอกสารประกอบการติดตั้งที่ครอบคลุม (AC: 8)
      - [ ] สร้างคู่มือการติดตั้งพร้อมคำแนะนำทีละขั้นตอนสำหรับแต่ละสภาพแวดล้อม
      - [ ] จัดทำเอกสาร Environment Variable ที่จำเป็นทั้งหมดพร้อมคำอธิบายและตัวอย่าง
      - [ ] เพิ่มคำแนะนำการติดตั้ง Docker พร้อมตัวอย่าง docker-compose
      - [ ] จัดทำเอกสาร Endpoint Health Check และคำแนะนำสำหรับการ Monitoring
      - [ ] สร้างคู่มือการแก้ไขปัญหาสำหรับการติดตั้งทั่วไป
      - [ ] เพิ่ม Checklist ด้านความปลอดภัยสำหรับการติดตั้งใน Production
  - [ ] สร้าง Unit Test ที่ครอบคลุมสำหรับการตั้งค่าและฟีเจอร์การติดตั้ง (AC: 1-8)
      - [ ] ทดสอบการตรวจสอบ Environment Variable ในสถานการณ์การตั้งค่าที่หลากหลาย
      - [ ] ทดสอบการโหลดการตั้งค่าสำหรับสภาพแวดล้อมที่แตกต่างกัน (Dev, Staging, Prod)
      - [ ] ทดสอบ Endpoint Health Check ในสถานการณ์ที่ Dependency ล้มเหลว
      - [ ] ทดสอบการจัดการการปิดระบบอย่างนุ่มนวลเมื่อมี Connection ที่ยังทำงานอยู่
      - [ ] ทดสอบการตั้งค่า Logging และรูปแบบ Structured Log
      - [ ] ทดสอบ Security Header และการตั้งค่า CORS
      - [ ] ทดสอบพฤติกรรมของ Docker Container เมื่อเริ่มต้นและเมื่อมี Health Check
      - [ ] ทดสอบการจัดการข้อผิดพลาดในการตั้งค่าเมื่อ Environment Variable ขาดหายไป

## Dev Notes

### ข้อมูลเชิงลึกจาก Story ก่อนหน้า

Story 4.1-4.2 ได้จัดทำเอกสาร API และการจัดการข้อผิดพลาดที่ครอบคลุมแล้ว ระบบตอนนี้ต้องการการตั้งค่าและการติดตั้งที่พร้อมสำหรับ Production เพื่อให้พร้อมสำหรับการปฏิบัติงานในสภาพแวดล้อมต่างๆ

### บริบททางสถาปัตยกรรมทางเทคนิค

**Runtime และการติดตั้ง** [ที่มา: architecture/tech-stack.md]:

  - **Bun**: 1.0.21+ Runtime JavaScript/TypeScript ที่มีเวลาเริ่มต้นรวดเร็ว
  - **Docker**: 24.0+ สำหรับการติดตั้งแอปพลิเคชันอย่างสม่ำเสมอ
  - **Environment Config**: dotenv 16.3+ สำหรับการจัดการการตั้งค่าด้วยการโหลด Environment Variable
  - **Logging**: Pino 8.17+ สำหรับ Log แบบ JSON ที่มีประสิทธิภาพสูงและพร้อมใช้งานใน Production

**กลยุทธ์การติดตั้ง** [ที่มา: architecture/infrastructure-and-deployment.md]:

  - การติดตั้งแบบ Application Container เดี่ยวพร้อม Dependency ของบริการภายนอก
  - ไม่จำกัดแพลตฟอร์มการติดตั้งแบบ Docker-based
  - การสร้าง Docker แบบ Multi-stage ที่ปรับให้เหมาะสมสำหรับ Production
  - ขั้นตอนการโปรโมตสภาพแวดล้อม: Development → Staging → Production

### Data Models

**Schema การตั้งค่าสภาพแวดล้อม**:

```typescript
interface EnvironmentConfig {
  // การตั้งค่าฐานข้อมูล
  DATABASE_URL: string;
  
  // การตั้งค่า MinIO  
  MINIO_ENDPOINT: string;
  MINIO_ACCESS_KEY: string;
  MINIO_SECRET_KEY: string;
  MINIO_BUCKET_NAME: string;
  MINIO_USE_SSL: boolean;
  
  // การตั้งค่า Redis (เป็นทางเลือก)
  REDIS_URL?: string;
  
  // การตั้งค่าแอปพลิเคชัน
  PORT: number;
  NODE_ENV: 'development' | 'staging' | 'production';
  LOG_LEVEL: 'debug' | 'info' | 'warn' | 'error';
  
  // การตั้งค่าความปลอดภัย
  CORS_ORIGINS: string;
  SHUTDOWN_TIMEOUT: number;
}
```

**รูปแบบการตอบกลับ Health Check**:

```typescript
interface HealthCheckResponse {
  status: 'healthy' | 'degraded' | 'unhealthy';
  version: string;
  uptime: number;
  timestamp: string;
  dependencies: {
    database: {
      status: 'connected' | 'disconnected' | 'error';
      responseTime?: number;
      error?: string;
    };
    minio: {
      status: 'connected' | 'disconnected' | 'error';
      responseTime?: number;
      error?: string;
    };
    redis?: {
      status: 'connected' | 'disconnected' | 'error';
      responseTime?: number;
      error?: string;
    };
  };
}
```

### File Locations

**โครงสร้าง Source Tree** [ที่มา: architecture/source-tree.md]:

  - **การตั้งค่าสภาพแวดล้อม**: `src/shared/config/env.ts` และ `src/shared/config/app.config.ts`
  - **บริการ Health Check**: `src/features/health/health.service.ts` และ `src/features/health/health.routes.ts`
  - **จุดเริ่มต้นของแอปพลิเคชัน**: `src/index.ts` สำหรับการจัดการการปิดระบบอย่างนุ่มนวล
  - **การตั้งค่า Docker**: `Dockerfile` และ `docker-compose.yml` ใน Root ของโปรเจกต์
  - **เอกสารประกอบ**: `docs/deployment/` สำหรับคู่มือการติดตั้งและการอ้างอิงสภาพแวดล้อม

### ข้อกำหนดด้านความปลอดภัยและการตั้งค่า

**การจัดการ Secret** [ที่มา: architecture/security.md\#secrets-management]:

  - ข้อมูลที่ละเอียดอ่อนทั้งหมดต้องมาจาก Environment Variable เท่านั้น - ห้าม Hardcode Secret เด็ดขาด
  - เข้าถึงผ่านบริการการตั้งค่าแบบรวมศูนย์พร้อมการตรวจสอบและค่าเริ่มต้น
  - ห้ามมี Secret ใน Log หรือข้อความแจ้งข้อผิดพลาด - ใช้การตอบกลับข้อผิดพลาดที่ผ่านการทำความสะอาด
  - ใช้บริการจัดการ Secret ภายนอกสำหรับสภาพแวดล้อม Production

**การตรวจสอบ Environment Variable**:

  - Environment Variable ที่จำเป็นต้องถูกตรวจสอบเมื่อเริ่มต้นแอปพลิเคชัน
  - ข้อผิดพลาดในการตั้งค่าควรป้องกันไม่ให้แอปพลิเคชันเริ่มต้น พร้อมข้อความแจ้งข้อผิดพลาดที่ชัดเจน
  - สภาพแวดล้อม Development ควรมีค่าเริ่มต้นที่เหมาะสมสำหรับการตั้งค่าที่เป็นทางเลือก
  - สภาพแวดล้อม Production ต้องกำหนดให้ Environment Variable ที่สำคัญต่อความปลอดภัยทั้งหมดจำเป็น

**แนวทางปฏิบัติเพื่อความปลอดภัยของ Docker** [ที่มา: architecture/infrastructure-and-deployment.md\#production-dockerfile]:

  - การสร้างแบบ Multi-stage พร้อม Stage สำหรับ Builder และ Production
  - ให้ Container ทำงานในฐานะ Non-root User (bunjs user with UID 1001)
  - อิมเมจ Production มีขนาดเล็กที่สุดพร้อม Dependency ที่จำเป็นเท่านั้น
  - ตั้งค่า Health Check สำหรับระบบจัดการ Container

### ข้อกำหนดด้าน Logging และ Monitoring

**Structured Logging** [ที่มา: architecture/error-handling-strategy.md\#logging-standards]:

  - **Library**: Pino 8.17+ พร้อมรูปแบบ Log แบบ JSON ที่มีโครงสร้าง
  - **ระดับ**: DEBUG (สำหรับ Dev เท่านั้น), INFO (เหตุการณ์ของแอป), WARN (กู้คืนได้), ERROR (ความล้มเหลว)
  - **บริบทที่จำเป็น**: Correlation ID (`req-{uuid}`), บริบทของบริการ, บริบทของผู้ใช้
  - **บริบทของบริการ**: ชื่อบริการ, เวอร์ชัน, สภาพแวดล้อม, ID Instance

**การตรวจสอบ Health Check**:

  - Endpoint Health Check ต้องให้รายละเอียดสถานะของ Dependency ทั้งหมด
  - การตรวจสอบการเชื่อมต่อฐานข้อมูลพร้อมสถานะ Connection Pool
  - การตรวจสอบการเชื่อมต่อบริการ MinIO พร้อมการยืนยันการเข้าถึง Bucket
  - การตรวจสอบการเชื่อมต่อ Redis หากมีการตั้งค่า Redis
  - รหัสสถานะ HTTP ที่เหมาะสมตามสถานะโดยรวมของบริการ

### การตั้งค่าความปลอดภัยของ Production

**ความปลอดภัยของ API** [ที่มา: architecture/security.md\#api-security]:

  - **นโยบาย CORS**: CORS ในตัวของ ElysiaJS พร้อม Origin เฉพาะสภาพแวดล้อม
  - **Security Headers**: Standard Security Headers สำหรับการตอบกลับ API
  - **การบังคับใช้ HTTPS**: จัดการโดย Caddy Reverse Proxy, API จะถือว่ามีการยกเลิก HTTPS ที่จุดนี้
  - **Rate Limiting**: ไม่ได้นำมาใช้ใน MVP - จัดการโดย Caddy Reverse Proxy

**การปกป้องข้อมูล** [ที่มา: architecture/security.md\#data-protection]:

  - **การเข้ารหัสข้อมูลขณะพัก (Encryption at Rest)**: จัดการโดยการตั้งค่าเซิร์ฟเวอร์ PostgreSQL และ MinIO
  - **การเข้ารหัสข้อมูลระหว่างการส่ง (Encryption in Transit)**: บังคับใช้ HTTPS โดย Caddy Proxy
  - **การจัดการ PII**: ที่อยู่อีเมลของผู้ใช้จะถูก Log ใน Structured Log เท่านั้น และไม่เคยอยู่ใน Error Response
  - **ข้อจำกัดการ Logging**: ทำความสะอาด Log ทั้งหมด - ห้ามมีรหัสผ่าน, Token, หรือเนื้อหาไฟล์ที่ละเอียดอ่อน

### Technical Constraints

**มาตรฐานการตั้งค่า** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - เข้าถึง Environment Variable ผ่าน Config Module เท่านั้น - ห้ามใช้ `process.env` โดยตรง
  - การตั้งค่าทั้งหมดต้องใช้โหมด Strict ของ TypeScript พร้อมคำจำกัดความประเภทข้อมูลที่เหมาะสม
  - การตรวจสอบการตั้งค่าต้องป้องกันไม่ให้แอปพลิเคชันเริ่มต้นเมื่อมีการตั้งค่าที่ไม่ถูกต้อง
  - การจัดการข้อผิดพลาดต้องคง Correlation ID จากบริบทของคำขอไว้

**ข้อกำหนดการติดตั้ง**:

  - Docker Container ต้องได้รับการปรับให้เหมาะสมสำหรับ Production ด้วยพื้นที่โจมตีที่น้อยที่สุด
  - Health Check ต้องตอบกลับภายใน 3 วินาทีสำหรับระบบจัดการ Container
  - การปิดระบบอย่างนุ่มนวลต้องเสร็จสมบูรณ์ภายในช่วง Timeout ที่กำหนดได้
  - การตั้งค่าต้องรองรับสภาพแวดล้อมการติดตั้งที่หลากหลายโดยไม่ต้องแก้ไขโค้ด

### Testing

**Framework และตำแหน่งไฟล์** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **Framework**: Bun Test (มีมาให้ในตัว) พร้อมรองรับ TypeScript
  - **รูปแบบชื่อไฟล์**: ไฟล์ `*.test.ts` อยู่ร่วมกับไฟล์ต้นฉบับ
  - **ตำแหน่ง**: Tests อยู่คู่กับไฟล์ Config, Health และ Infrastructure

**ข้อกำหนดด้าน Coverage** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - Code coverage 80% สำหรับ Logic การตรวจสอบการตั้งค่าและ Health Check
  - ทดสอบสถานการณ์การตั้งค่าสภาพแวดล้อมทั้งหมด รวมถึงสภาวะข้อผิดพลาด
  - ทดสอบพฤติกรรมการปิดระบบอย่างนุ่มนวลเมื่อมีการจำลอง Connection ที่ยังทำงานอยู่

**ข้อกำหนด Test ที่เจาะจง**:

  - ทดสอบการตรวจสอบ Environment Variable ที่ขาดหายไป, ไม่ถูกต้อง และถูกต้อง
  - ทดสอบ Endpoint Health Check ในสถานการณ์ความล้มเหลวของ Dependency ที่หลากหลาย
  - ทดสอบการจัดการการปิดระบบอย่างนุ่มนวลเมื่อมีคำขอและการเชื่อมต่อฐานข้อมูลที่ยังทำงานอยู่
  - ทดสอบการตั้งค่า Logging ด้วยระดับ Log และสภาพแวดล้อมที่แตกต่างกัน
  - ทดสอบ Security Header และการตั้งค่า CORS สำหรับสภาพแวดล้อมที่แตกต่างกัน
  - ทดสอบพฤติกรรมของ Docker Container ด้วย Health Check และสัญญาณการปิดระบบ
  - ทดสอบการโหลดการตั้งค่าสำหรับสภาพแวดล้อม Development, Staging และ Production

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | สร้าง Story เริ่มต้นสำหรับการตั้งค่า Production และการจัดการสภาพแวดล้อม | Scrum Master |
