---
## เรื่องที่ 3.4: การบังคับใช้การควบคุมการเข้าถึงและการกรองไฟล์

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะผู้ใช้งาน API** ผมต้องการให้การเข้าถึงไฟล์ถูกจำกัดตามบทบาทที่ได้รับ เพื่อให้ผมสามารถดูและเข้าถึงได้เฉพาะไฟล์ที่บทบาทของผมได้รับอนุญาต

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **GET /files** จะต้องกรองผลลัพธ์ให้แสดงเฉพาะไฟล์ที่บทบาทของผู้ใช้สามารถเข้าถึงได้
2.  Endpoint **GET /files/{id}** จะต้องส่งคืน **404 Not Found** สำหรับไฟล์ที่บทบาทของผู้ใช้ไม่สามารถเข้าถึงได้
3.  การตรวจสอบสิทธิ์การเข้าถึงไฟล์ต้องถูกสร้างเป็นฟังก์ชัน Middleware ที่สามารถนำกลับมาใช้ใหม่ได้
4.  การค้นหาสิทธิ์จะต้องถูกปรับปรุงประสิทธิภาพโดยใช้การเชื่อมต่อตารางของ **Prisma** ระหว่าง Files และ FileRolePermissions
5.  ผู้ใช้สามารถเข้าถึงไฟล์ได้หากมีสิทธิ์จาก **บทบาทใดบทบาทหนึ่ง** (ใช้ OR logic ไม่ใช่ AND)
6.  รายการไฟล์ที่ส่งกลับต้องมีข้อมูลเมตาเกี่ยวกับสิทธิ์การเข้าถึงของผู้ใช้
7.  ประสิทธิภาพต้องถูกปรับปรุงให้เหมาะสมสำหรับกรณีที่มีไฟล์จำนวนมากและมีการกำหนดบทบาทที่ซับซ้อน
8.  มีการตรวจสอบความปลอดภัยอย่างเข้มงวด: จะต้องไม่มีการเปิดเผยข้อมูลเกี่ยวกับไฟล์ที่ผู้ใช้ไม่สามารถเข้าถึงได้

### งานหลัก / งานย่อย

- [ ] สร้าง Middleware สำหรับการตรวจสอบสิทธิ์ไฟล์ที่นำกลับมาใช้ใหม่ได้ (เกณฑ์ 3, 8)
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.middleware.ts` พร้อม logic การตรวจสอบสิทธิ์
    - [ ] สร้างฟังก์ชัน `checkFileAccess()` โดยใช้ `UserContext` จาก Header
    - [ ] ตรวจสอบว่าผู้ใช้มีสิทธิ์เข้าถึงไฟล์เป้าหมายโดยใช้บทบาท **ใดบทบาทหนึ่ง** (OR logic)
    - [ ] ส่งคืน **HTTP 404** สำหรับการเข้าถึงที่ไม่ได้รับอนุญาต (เพื่อไม่ให้เปิดเผยว่าไฟล์มีอยู่จริง)
    - [ ] นำ Middleware ไปใช้กับ Endpoint ที่ต้องมีการตรวจสอบสิทธิ์
- [ ] ปรับปรุงประสิทธิภาพการค้นหาสิทธิ์ด้วย Database Joins (เกณฑ์ 4, 7)
    - [ ] อัปเดต `src/features/files/files.repository.ts` ด้วย query ที่คำนึงถึงสิทธิ์
    - [ ] สร้างเมธอด `findFilesByUserRoles()` โดยใช้ Prisma joins กับ FileRolePermissions
    - [ ] สร้างเมธอด `findFileByIdWithPermissions()` สำหรับการตรวจสอบการเข้าถึงไฟล์เดี่ยว
    - [ ] ใช้ `where` clause ของ Prisma พร้อม OR logic สำหรับบทบาทของผู้ใช้หลายบทบาท
    - [ ] ปรับปรุงประสิทธิภาพของ query ด้วยการใช้ Index ที่เหมาะสมกับความสัมพันธ์ของบทบาทและไฟล์
    - [ ] เพิ่มข้อมูลเมตาของสิทธิ์เข้าไปใน response ของไฟล์
- [ ] สร้าง Service สำหรับการกรองไฟล์ตามบทบาท (เกณฑ์ 1, 5, 6)
    - [ ] อัปเดต `src/features/files/files.service.ts` ด้วยการทำงานที่คำนึงถึงสิทธิ์
    - [ ] สร้างเมธอด `getUserAccessibleFiles()` เพื่อกรองไฟล์ตามบทบาทของผู้ใช้
    - [ ] สร้างเมธอด `getUserFileById()` พร้อมการตรวจสอบสิทธิ์
    - [ ] ใช้ logic การอนุญาตแบบ **"ANY" role** สำหรับการตัดสินใจการเข้าถึง
    - [ ] เพิ่มข้อมูลเมตาของระดับการเข้าถึงใน response ของไฟล์
    - [ ] จัดการกรณีพิเศษสำหรับผู้ใช้ที่ไม่มีบทบาทหรือไม่มีสิทธิ์ใดๆ
- [ ] อัปเดต Endpoint REST API ด้วยการควบคุมการเข้าถึง (เกณฑ์ 1, 2)
    - [ ] อัปเดต `src/features/files/files.routes.ts` พร้อมนำ Middleware สิทธิ์มาใช้
    - [ ] แก้ไข Endpoint `GET /files` เพื่อกรองผลลัพธ์ตามไฟล์ที่ผู้ใช้เข้าถึงได้
    - [ ] แก้ไข Endpoint `GET /files/{id}` เพื่อส่งคืน **404** เมื่อเข้าถึงไฟล์ที่ไม่ได้รับอนุญาต
    - [ ] นำ Middleware การตรวจสอบสิทธิ์ไปใช้กับ Endpoint ไฟล์ที่ต้องมีการป้องกัน
    - [ ] ตรวจสอบให้แน่ใจว่าการตอบกลับข้อผิดพลาดและ Correlation ID ยังคงสอดคล้องกัน
    - [ ] รักษาการทำงานของ pagination และ Query parameter ที่มีอยู่เดิม
- [ ] สร้าง Unit tests ที่ครอบคลุม (เกณฑ์ทั้งหมด)
    - [ ] สร้างไฟล์ `src/features/permissions/__tests__/permissions.middleware.test.ts`
    - [ ] สร้าง Unit test ที่อัปเดตแล้วใน `src/features/files/__tests__/`
    - [ ] ทดสอบการกรองไฟล์ตามบทบาทของผู้ใช้ด้วยสถานการณ์ OR logic
    - [ ] ทดสอบการเข้าถึงไฟล์ที่ไม่ได้รับอนุญาตที่ส่งคืน **404** โดยไม่มีการเปิดเผยข้อมูล
    - [ ] ทดสอบการรวมข้อมูลเมตาของสิทธิ์เข้าไปใน response ของไฟล์
    - [ ] ทดสอบประสิทธิภาพสำหรับกรณีที่มีไฟล์และบทบาทจำนวนมาก
    - [ ] Mock `UserContext` ด้วยการผสมผสานบทบาทที่แตกต่างกันเพื่อการทดสอบที่ครอบคลุม

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 3.1, 3.2 และ 3.3 ได้สร้างรากฐานของระบบ RBAC (Role-Based Access Control) ที่สมบูรณ์แล้ว: การแยกวิเคราะห์ Header ของ Caddy พร้อม `UserContext`, ระบบจัดการบทบาท, และระบบจัดการสิทธิ์ไฟล์ งานนี้จะนำทุกอย่างมารวมกันโดยการบังคับใช้การควบคุมการเข้าถึงที่กรองและปกป้องไฟล์ตามบทบาทของผู้ใช้

#### สถาปัตยกรรมทางเทคนิค
* **เฟรมเวิร์ก ElysiaJS:**
    * ใช้ ElysiaJS สำหรับ API, Schema validation และ Middleware
* **การจัดการฐานข้อมูล:**
    * ใช้ Repository pattern
    * **Prisma joins** เป็นสิ่งจำเป็นสำหรับ query ที่มีประสิทธิภาพ
    * มีการจัดการการเข้าถึงพร้อมกัน
* **ข้อกำหนดด้านความปลอดภัย:**
    * ผู้ใช้สามารถเห็นและเข้าถึงได้เฉพาะไฟล์ที่มีสิทธิ์เท่านั้น
    * ไม่มีข้อมูลรั่วไหลเกี่ยวกับไฟล์ที่เข้าถึงไม่ได้ (ตอบกลับด้วย 404 เสมอ)
    * ใช้ logic แบบ "ANY" role: หากบทบาทใดบทบาทหนึ่งได้รับสิทธิ์ ก็สามารถเข้าถึงได้

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test**
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน middleware และ service
    * Unit test สำหรับทุกสถานการณ์การตรวจสอบสิทธิ์
* **การจำลองข้อมูล:** ใช้ Bun’s built-in mock สำหรับ Prisma client และ ElysiaJS context
* **รูปแบบการจัดเรียง Test:**
    * **Middleware tests:** `permissions.middleware.test.ts`
    * **Repository/Service/Routes tests:** ใน `src/features/files/__tests__/`
    * ใช้รูปแบบ **AAA** (Arrange, Act, Assert)
* **ข้อกำหนดการทดสอบเฉพาะ:**
    * ทดสอบการกรองไฟล์ตามบทบาทที่หลากหลาย
    * ทดสอบการตอบกลับ **404** สำหรับการเข้าถึงที่ไม่ได้รับอนุญาต
    * ทดสอบ logic การอนุญาตแบบ **ANY** role
    * ทดสอบกรณีพิเศษ: ผู้ใช้ไม่มีบทบาท, ไม่มีสิทธิ์, หรือไฟล์ไม่มีอยู่จริง
