---
## เรื่องที่ 2.4: การเชื่อมต่อกระบวนการอัปโหลดไฟล์แบบครบวงจร

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะนักพัฒนาส่วนหน้า (frontend)** ผมต้องการกระบวนการอัปโหลดไฟล์ที่สมบูรณ์ เพื่อให้ผมสามารถอัปโหลดไฟล์ได้ด้วยการเรียกใช้ API เพียงครั้งเดียว

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **POST /files** ต้องสร้างข้อมูลไฟล์ในฐานข้อมูล และส่งคืน Presigned URL ในการตอบกลับเพียงครั้งเดียว
2.  รูปแบบการตอบกลับต้องมีข้อมูล: **`{id, filename, filetype, presignedUrl, uploadUrl}`**
3.  ข้อมูลไฟล์ที่ถูกสร้างขึ้นในฐานข้อมูลต้องมีสถานะเป็น "pending" จนกว่าการอัปโหลดจะเสร็จสมบูรณ์
4.  มีการจัดการข้อผิดพลาดสำหรับกรณีชื่อไฟล์ซ้ำ โดยส่งคืน HTTP status code ที่เหมาะสม
5.  มีการตรวจสอบขนาดไฟล์ที่อัปโหลดเทียบกับขนาดสูงสุดที่กำหนดไว้ (สามารถตั้งค่าได้ผ่าน Environment variable)
6.  มีการตรวจสอบว่า `Content-Type` ที่ส่งมาตรงกับประเภทไฟล์ที่ระบุในคำขอ
7.  มีการจัดการ transaction เพื่อให้ข้อมูลในฐานข้อมูลมีความสอดคล้องกัน แม้ว่าการทำงานกับ MinIO จะล้มเหลว
8.  มี Integration test ที่ครอบคลุมกระบวนการทั้งหมดตั้งแต่การสร้างข้อมูลในฐานข้อมูลไปจนถึงการสร้าง Presigned URL

### งานหลัก / งานย่อย

- [ ] ปรับปรุง Endpoint **POST /files** ให้ส่งคืน Presigned URL (เกณฑ์ 1, 2)
    - [ ] แก้ไข Endpoint `POST /files` ใน `files.routes.ts`
    - [ ] อัปเดต ElysiaJS Schema เพื่อรวม Presigned URL ในการตอบกลับ
    - [ ] เชื่อมต่อการสร้าง MinIO Presigned URL เข้าไปในการตอบกลับ
    - [ ] ตรวจสอบว่า response มีข้อมูลครบถ้วน: id, filename, filetype, presignedUrl, uploadUrl
- [ ] เพิ่มการตรวจสอบชื่อไฟล์ซ้ำ (เกณฑ์ 4)
    - [ ] เพิ่มการตรวจสอบว่าชื่อไฟล์ไม่ซ้ำกันใน `files.service.ts`
    - [ ] ส่งคืน **HTTP 409 Conflict** เมื่อชื่อไฟล์ซ้ำ
    - [ ] จัดการข้อความแจ้งเตือนข้อผิดพลาดสำหรับกรณีนี้ให้เหมาะสม
- [ ] เพิ่มการตรวจสอบขนาดไฟล์ที่กำหนดได้ (เกณฑ์ 5)
    - [ ] เพิ่ม Environment variable `MAX_FILE_SIZE` ใน `shared/config/env.ts`
    - [ ] สร้าง validation สำหรับขนาดไฟล์ใน `files.validation.ts`
    - [ ] ส่งคืน **HTTP 413 Payload Too Large** สำหรับไฟล์ที่มีขนาดเกิน
- [ ] เพิ่มการตรวจสอบ `Content-Type` (เกณฑ์ 6)
    - [ ] เพิ่มการตรวจสอบประเภทไฟล์ตามรายการที่อนุญาตใน `files.validation.ts`
    - [ ] ตรวจสอบว่า header `Content-Type` ตรงกับประเภทไฟล์ที่ระบุ
    - [ ] ส่งคืน **HTTP 415 Unsupported Media Type** สำหรับประเภทไฟล์ที่ไม่ถูกต้อง
- [ ] เพิ่มการจัดการ transaction เพื่อให้ข้อมูลสอดคล้องกัน (เกณฑ์ 7)
    - [ ] ห่อหุ้มการสร้างไฟล์และการทำงานกับ MinIO ไว้ใน Prisma transaction
    - [ ] สร้าง logic สำหรับการ rollback (ย้อนกลับ) การเปลี่ยนแปลงในฐานข้อมูล หากการสร้าง Presigned URL ล้มเหลว
    - [ ] ตรวจสอบให้แน่ใจว่าไม่มีข้อมูลที่ค้างอยู่ในฐานข้อมูลหากเกิดข้อผิดพลาด
- [ ] สร้าง Integration test ที่ครอบคลุม (เกณฑ์ 8)
    - [ ] เพิ่ม Integration test ใน `files.routes.test.ts`
    - [ ] ทดสอบกระบวนการทั้งหมดตั้งแต่ request จนถึง response ของ Presigned URL
    - [ ] Mock การทำงานกับ MinIO และตรวจสอบการจัดการ transaction
    - [ ] ทดสอบกรณีที่เกิดข้อผิดพลาดและพฤติกรรมการ rollback

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 2.1, 2.2 และ 2.3 ได้สร้างพื้นฐานสำหรับการจัดการข้อมูลไฟล์, การเชื่อมต่อ MinIO และการแสดงรายการไฟล์ งานนี้จะนำการสร้างไฟล์ (2.1) และการสร้าง Presigned URL (2.2) มารวมกันเป็นกระบวนการเดียว เพื่อลดจำนวนการเรียกใช้ API และทำให้การทำงานของส่วนหน้า (frontend) ง่ายขึ้น

#### โครงสร้าง Data Model ของไฟล์
* **`id`**: UUID - Primary key ที่ส่งคืนในการตอบกลับ
* **`filename`**: String - ชื่อไฟล์ที่ตรวจสอบว่าไม่ซ้ำกัน
* **`filetype`**: String - ประเภทไฟล์ที่ตรวจสอบกับรายการที่อนุญาต
* **`fileSize`**: BigInt - ขนาดไฟล์ที่ตรวจสอบกับ `MAX_FILE_SIZE`
* **`uploadStatus`**: Enum - มีค่าเริ่มต้นเป็น `PENDING` สำหรับไฟล์ใหม่

#### รายละเอียดการทำงานของการอัปโหลดไฟล์แบบครบวงจร
* **กระบวนการ:** `POST /files` ควรจะสร้างข้อมูลไฟล์และส่งคืน Presigned URL ในการตอบกลับเพียงครั้งเดียว ซึ่งจะช่วยลดจำนวน API calls ที่ส่วนหน้าต้องทำ

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test**
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน service และ business logic
    * Integration test สำหรับ Endpoint การทำงานแบบครบวงจร
    * Unit test สำหรับ logic การตรวจสอบความถูกต้องและการจัดการข้อผิดพลาด
* **การจำลองข้อมูล:** ใช้ Bun's built-in mock สำหรับ Prisma client และ MinIO SDK
* **รูปแบบการจัดเรียง Test:**
    * **Integration tests:** `files.routes.test.ts` (เพิ่มการทดสอบสำหรับ POST /files)
    * **Service tests:** `files.service.test.ts` (เพิ่มการทดสอบเมธอดการสร้างแบบรวม)
    * **Validation tests:** `files.validation.test.ts` (เพิ่มการทดสอบขนาดและประเภทไฟล์)
* **ข้อกำหนด Integration Test:**
    * ทดสอบกระบวนการทั้งหมดตั้งแต่ request ไปจนถึง response ของ Presigned URL
    * ทดสอบการ rollback transaction เมื่อ MinIO ล้มเหลว
    * ทดสอบทุกสถานการณ์การตรวจสอบความถูกต้อง (ขนาดไฟล์, ประเภท, ชื่อไฟล์ซ้ำ)
    * ทดสอบการตอบกลับข้อผิดพลาดด้วย HTTP status code ที่เหมาะสม
