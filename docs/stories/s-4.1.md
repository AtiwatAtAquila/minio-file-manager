# Story 4.1: การจัดทำเอกสาร OpenAPI ที่สมบูรณ์

## สถานะ

แบบร่าง

## Story

**ในฐานะ** ผู้ใช้งาน API
**ฉันต้องการ** เอกสาร API ที่ครอบคลุมและสามารถโต้ตอบได้
**เพื่อที่จะ** ทำความเข้าใจและนำไปใช้งานร่วมกับทุกๆ Endpoint ได้อย่างมีประสิทธิภาพ

## เกณฑ์การยอมรับ

1.  เอกสาร OpenAPI ต้องครอบคลุมทุก Endpoint พร้อม Schema ที่สมบูรณ์สำหรับคำขอและคำตอบ
2.  ทุก Endpoint ต้องมีคำอธิบาย, พารามิเตอร์, และตัวอย่างคำขอ/คำตอบที่ครบถ้วน
3.  ต้องระบุข้อกำหนดด้านการยืนยันตัวตน (Authentication) อย่างชัดเจนสำหรับทุก Endpoint
4.  ต้องมีเอกสารอธิบายรูปแบบการตอบกลับเมื่อเกิดข้อผิดพลาด (Error Response) พร้อมสถานะ HTTP (Status Code) ที่เป็นไปได้ทั้งหมด
5.  ต้องสามารถเข้าถึงหน้าเอกสารแบบโต้ตอบ (Scalar) ได้ที่ `/docs` พร้อมตัวอย่างการใช้งานที่ถูกต้อง
6.  ต้องมี Endpoint สำหรับไฟล์ `openapi.json` ที่ `/openapi.json` เพื่อการนำไปใช้งานด้วยโปรแกรม
7.  แบบจำลองคำขอและคำตอบ (Request/Response Models) ต้องมีคำจำกัดความประเภทข้อมูล (Type Definitions) ของ TypeScript
8.  หน้าเอกสารแบบโต้ตอบต้องอนุญาตให้สามารถทดสอบ Endpoint ได้โดยตรงจากเบราว์เซอร์

## งาน / งานย่อย

  - [ ] จัดทำเอกสารสำหรับทุก Endpoint พร้อม Schema ของ OpenAPI (AC: 1, 2, 3)
      - [ ] จัดทำเอกสาร Endpoint ที่จัดการไฟล์ทั้งหมดใน `src/features/files/files.routes.ts`
      - [ ] จัดทำเอกสาร Endpoint ที่จัดการ Role ทั้งหมดใน `src/features/roles/roles.routes.ts`
      - [ ] จัดทำเอกสาร Endpoint ที่จัดการสิทธิ์ทั้งหมดใน `src/features/permissions/permissions.routes.ts`
      - [ ] จัดทำเอกสาร Endpoint สำหรับผู้ดูแลระบบทั้งหมดใน `src/features/admin/admin.routes.ts`
      - [ ] จัดทำเอกสาร Endpoint สำหรับการตรวจสอบสถานะระบบ (Health Check) ใน `src/features/health/health.routes.ts`
      - [ ] ใส่ Schema ที่สมบูรณ์ของคำขอ/คำตอบสำหรับทุก Endpoint
      - [ ] เพิ่มคำอธิบาย Endpoint, เอกสารประกอบพารามิเตอร์, และตัวอย่างการใช้งาน
      - [ ] ระบุข้อกำหนดด้านการยืนยันตัวตน (Header จาก Caddy) สำหรับทุก Endpoint ที่มีการป้องกัน
  - [ ] จัดทำเอกสารรูปแบบการตอบกลับเมื่อเกิดข้อผิดพลาดอย่างครอบคลุม (AC: 4)
      - [ ] ระบุรหัสสถานะ HTTP (HTTP Status Code) ที่ Endpoint แต่ละตัวสามารถตอบกลับได้ทั้งหมด
      - [ ] สร้าง Schema สำหรับการตอบกลับข้อผิดพลาดที่ตรงกับรูปแบบ ErrorResponse ตามมาตรฐานการเขียนโค้ด
      - [ ] ใส่ตัวอย่างข้อผิดพลาดสำหรับกรณีต่างๆ เช่น ข้อมูลไม่ถูกต้อง, การยืนยันตัวตนผิดพลาด, และข้อผิดพลาดจากเซิร์ฟเวอร์
      - [ ] อธิบายการใช้ Correlation ID ในการตอบกลับข้อผิดพลาด
  - [ ] ตั้งค่าและปรับปรุงหน้าเอกสาร Scalar (AC: 5, 8)
      - [ ] ตรวจสอบให้แน่ใจว่า UI ของ Scalar ได้รับการตั้งค่าอย่างถูกต้องที่ Endpoint `/docs`
      - [ ] ตั้งค่าให้สามารถทดสอบการโต้ตอบได้ภายในหน้าเอกสาร
      - [ ] ยืนยันว่าทุก Endpoint สามารถทดสอบได้จากเบราว์เซอร์
      - [ ] ตรวจสอบว่าการทดสอบการยืนยันตัวตนใช้งานได้ด้วยการจำลอง Header ของ Caddy
  - [ ] สร้าง Endpoint สำหรับไฟล์ OpenAPI JSON (AC: 6)
      - [ ] สร้าง Endpoint `/openapi.json` สำหรับให้บริการไฟล์ OpenAPI ที่สมบูรณ์
      - [ ] ตรวจสอบให้แน่ใจว่า Endpoint นี้สามารถเข้าถึงได้เพื่อการนำไปใช้ในโปรแกรม
      - [ ] ตรวจสอบความถูกต้องของรูปแบบเอกสาร OpenAPI
  - [ ] ปรับปรุงคำจำกัดความประเภทข้อมูลและ Schema (AC: 7)
      - [ ] ตรวจสอบว่า Schema ของ ElysiaJS ทั้งหมดเชื่อมโยงกับ Interface ของ TypeScript อย่างถูกต้อง
      - [ ] ยืนยันว่าแบบจำลองคำขอ/คำตอบมีข้อมูลประเภทข้อมูลที่ครบถ้วน
      - [ ] ตรวจสอบความสอดคล้องกันระหว่าง Schema กับ Data Model จากเอกสารสถาปัตยกรรม
      - [ ] ตรวจสอบว่าการตรวจสอบ Schema ทำงานสอดคล้องกับประเภทข้อมูลของ TypeScript
  - [ ] สร้าง Unit Test ที่ครอบคลุมสำหรับฟังก์ชันเอกสาร (AC: 1-8)
      - [ ] ทดสอบการสร้างเอกสาร OpenAPI และความสมบูรณ์ของข้อมูล
      - [ ] ทดสอบการเข้าถึงและความสามารถในการทำงานของ Endpoint `/docs`
      - [ ] ทดสอบการตอบกลับและรูปแบบของ Endpoint `/openapi.json`
      - [ ] ทดสอบความสอดคล้องของการตรวจสอบ Schema กับการทำงานจริงของ Endpoint
      - [ ] ทดสอบความถูกต้องของเอกสารการยืนยันตัวตนในสถานการณ์ Header ที่หลากหลาย

## Dev Notes

### ข้อมูลเชิงลึกจาก Story ก่อนหน้า

Story 1.1-3.5 ได้สร้างระบบ RBAC ที่สมบูรณ์พร้อมการยืนยันตัวตนด้วย Caddy, การจัดการ Role, สิทธิ์ในไฟล์, และฟังก์ชันสำหรับผู้ดูแลระบบ ตอนนี้ทุก Endpoint ได้ถูกนำไปใช้กับ Framework ElysiaJS และต้องการเอกสาร OpenAPI ที่ครอบคลุมสำหรับผู้ใช้งาน API ภายนอก

### บริบททางสถาปัตยกรรมทางเทคนิค

**ElysiaJS Framework** [ที่มา: architecture/tech-stack.md]:

  - ElysiaJS 0.8+ มีความสามารถในการสร้างเอกสาร OpenAPI ในตัว
  - หน้าเอกสารแบบโต้ตอบของ Scalar ที่ติดตั้งมาพร้อมกับ ElysiaJS สำหรับการทดสอบ API
  - ระบบการตรวจสอบ Schema ที่สร้างเอกสาร OpenAPI โดยอัตโนมัติ
  - การผสานการทำงานกับ TypeScript เพื่อให้มั่นใจในความปลอดภัยของประเภทข้อมูลระหว่าง Schema และการนำไปใช้งาน

**API Documentation Stack** [ที่มา: architecture/tech-stack.md]:

  - **Scalar**: หน้าเอกสารแบบโต้ตอบในตัวของ ElysiaJS
  - **OpenAPI 3.0**: สร้างขึ้นโดยอัตโนมัติจากคำจำกัดความ Schema ของ ElysiaJS
  - **Schema Validation**: ระบบ Schema ของ ElysiaJS สำหรับการตรวจสอบประเภทข้อมูลที่ปลอดภัย

### Data Models

**แบบจำลองการตอบกลับ API ที่สมบูรณ์** [ที่มา: architecture/data-models.md]:

```typescript
// แบบจำลองการตอบกลับไฟล์
interface File {
  id: string;
  filename: string;
  filetype: string;
  fileSize: bigint;
  uploadedAt: Date;
  minioKey: string;
  uploadStatus: 'pending' | 'completed' | 'failed';
}

// แบบจำลองการตอบกลับ Role  
interface Role {
  id: string;
  name: string;
  createdAt: Date;
  updatedAt: Date;
}

// แบบจำลองการตอบกลับสิทธิ์
interface FileRolePermission {
  fileId: string;
  roleName: string;
  grantedAt: Date;
  grantedBy: string;
}

// แบบจำลองการตอบกลับการ Query ของผู้ดูแลระบบ (จาก story 3.5)
interface AdminFileWithPermissions {
  id: string;
  filename: string;
  filetype: string;
  fileSize: bigint;
  uploadedAt: Date;
  minioKey: string;
  uploadStatus: 'pending' | 'completed' | 'failed';
  permissions: {
    roleName: string;
    grantedAt: Date;
    grantedBy: string;
  }[];
}
```

**รูปแบบการตอบกลับเมื่อเกิดข้อผิดพลาด** [ที่มา: architecture/coding-standards.md\#critical-rules]:

```typescript
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: unknown;
    correlationId: string;
  };
}
```

### File Locations

**โครงสร้าง Source Tree** [ที่มา: architecture/source-tree.md]:

  - **เส้นทางเอกสาร**: ตั้งค่า UI ของ Scalar ที่ Endpoint `/docs` ใน `src/app.ts`
  - **Endpoint OpenAPI**: สร้าง Endpoint `/openapi.json` ใน `src/app.ts`
  - **ไฟล์ Routes**: ไฟล์ Route ทั้งหมดใน `src/features/*/` ต้องมีเอกสาร Schema ของ OpenAPI
  - **ไฟล์ Schema**: อัปเดต Schema สำหรับการตรวจสอบในไฟล์ `src/features/*/validation.ts`

### API Specifications

**Endpoint ทั้งหมดที่ต้องจัดทำเอกสาร** [ที่มา: architecture/rest-api-specification.md]:

  - **Health**: `GET /health` - การตรวจสอบสถานะการทำงานของบริการ
  - **Files**: `GET /files`, `POST /files`, `GET /files/{id}`, `PATCH /files/{id}`, `DELETE /files/{id}`
  - **Permissions**: `POST /files/{id}/permissions`, `DELETE /files/{id}/permissions/{role}`
  - **Roles**: `GET /roles`, `POST /roles`, `PUT /roles/{id}`, `DELETE /roles/{id}`
  - **Admin**: `GET /roles/{role}/files`, `GET /files/by-role`

**ข้อกำหนดเอกสารการยืนยันตัวตน**:

  - Endpoint ที่มีการป้องกันทั้งหมดต้องใช้ Header ของ Caddy `forward_auth`
  - Header: `x-user-id`, `x-user-email`, `x-user-roles`
  - Endpoint ที่ใช้เฉพาะ Role "Boss" ต้องระบุข้อจำกัด Role อย่างชัดเจน
  - Endpoint ที่ไม่จำเป็นต้องยืนยันตัวตนต้องถูกระบุอย่างชัดเจน (Health, Docs)

### Technical Constraints

**ข้อกำหนดการสร้างเอกสาร OpenAPI** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - ต้องใช้ความสามารถในการสร้างเอกสาร OpenAPI ในตัวของ ElysiaJS
  - การตรวจสอบความถูกต้องของคำขอ/คำตอบทั้งหมดต้องใช้ระบบ Schema ของ ElysiaJS
  - โหมด Strict ของ TypeScript ทำให้มั่นใจในความปลอดภัยของประเภทข้อมูลระหว่าง Schema และการนำไปใช้งาน
  - การตรวจสอบ Schema ต้องสอดคล้องกับการทำงานจริงของ Endpoint

**มาตรฐานการจัดทำเอกสาร**:

  - การทดสอบแบบโต้ตอบต้องทำงานได้ด้วยการจำลองการยืนยันตัวตน
  - ทุก Endpoint ต้องมีเอกสารประกอบพารามิเตอร์และคำตอบที่สมบูรณ์
  - การตอบกลับเมื่อเกิดข้อผิดพลาดต้องเป็นไปตาม Schema ของ ErrorResponse ที่สอดคล้องกัน
  - ต้องมีการระบุการใช้ Correlation ID ในการจัดการข้อผิดพลาด

### Testing

**Framework และตำแหน่งไฟล์** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **Framework**: Bun Test (มีมาให้ในตัว) พร้อมรองรับ TypeScript
  - **รูปแบบชื่อไฟล์**: ไฟล์ `*.test.ts` อยู่ร่วมกับไฟล์ต้นฉบับ
  - **ตำแหน่ง**: Tests อยู่คู่กับไฟล์ Route และใน `src/app.test.ts` สำหรับ Endpoint ของเอกสาร

**ข้อกำหนดด้าน Coverage** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - Code coverage 80% สำหรับ logic การสร้างเอกสาร
  - ทดสอบความสมบูรณ์และความถูกต้องของเอกสาร OpenAPI
  - ทดสอบความสามารถในการทำงานของหน้าเอกสารแบบโต้ตอบ
  - ตรวจสอบความสอดคล้องของ Schema กับการนำไปใช้งานจริงของ Endpoint

**ข้อกำหนด Test ที่เจาะจง**:

  - ทดสอบว่า Endpoint `/docs` คืนค่าหน้า Scalar ที่ถูกต้อง
  - ทดสอบว่า Endpoint `/openapi.json` คืนค่าเอกสาร OpenAPI 3.0 ที่ถูกต้อง
  - ทดสอบว่าการตรวจสอบ Schema ตรงกับคำจำกัดความประเภทข้อมูลของ TypeScript
  - ทดสอบความถูกต้องของเอกสารการยืนยันตัวตนในสถานการณ์ Header ของ Caddy ที่หลากหลาย
  - ทดสอบว่าเอกสารการตอบกลับเมื่อเกิดข้อผิดพลาดตรงกับการจัดการข้อผิดพลาดจริง
  - ทดสอบว่าการทดสอบแบบโต้ตอบใช้งานได้กับทุก Endpoint ที่มีเอกสารประกอบ

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | สร้าง Story เริ่มต้นสำหรับการจัดทำเอกสาร OpenAPI ที่สมบูรณ์ | Scrum Master |
