---
## เรื่องที่ 2.2: การเชื่อมต่อ MinIO และ Presigned URLs

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะนักพัฒนาส่วนหน้า (frontend)** ผมต้องการได้รับ **Presigned URLs** สำหรับการอัปโหลดไฟล์ที่ปลอดภัย เพื่อให้ผมสามารถอัปโหลดไฟล์ได้โดยตรงไปยัง **MinIO** โดยไม่จำเป็นต้องเปิดเผยข้อมูลการเข้าถึง

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **POST /files/{id}/presigned-url** สามารถสร้าง MinIO Presigned URLs ที่มีอายุการใช้งาน 5 นาทีได้
2.  การสร้าง Presigned URL ต้องใช้ชื่อ bucket และ key ที่ถูกต้อง
3.  การตั้งค่าการเชื่อมต่อ MinIO ต้องโหลดมาจาก Environment variables
4.  หาก MinIO ไม่พร้อมใช้งาน ต้องจัดการข้อผิดพลาดโดยส่ง HTTP 500 พร้อมข้อความแจ้งให้ลองใหม่อีกครั้ง
5.  การตอบกลับของ Presigned URL ต้องมี URL สำหรับอัปโหลด, HTTP method, และ headers ที่จำเป็น
6.  ข้อมูลไฟล์ในฐานข้อมูลจะถูกอัปเดตด้วย MinIO key หลังจากสร้าง Presigned URL สำเร็จ
7.  MinIO SDK ต้องถูกตั้งค่าอย่างถูกต้อง โดยมีการจัดการ connection pooling และ timeout
8.  มี Unit test ครอบคลุมการเชื่อมต่อ MinIO โดยใช้ mock MinIO service

### งานหลัก / งานย่อย

- [ ] สร้างการทำงานในชั้น MinIO provider (เกณฑ์ 3, 7)
    - [ ] สร้างไฟล์ `minio.provider.ts` เพื่อตั้งค่าและจัดการ MinIO client
    - [ ] สร้างไฟล์ `minio.config.ts` สำหรับโหลดค่าจาก Environment variables
    - [ ] กำหนด `minio.types.ts` สำหรับประเภทข้อมูลที่เกี่ยวข้อง
    - [ ] เพิ่มการตั้งค่า connection pooling และ timeout
- [ ] สร้าง service สำหรับการสร้าง Presigned URL (เกณฑ์ 1, 2, 6)
    - [ ] เพิ่ม logic การสร้าง Presigned URL ใน `files.service.ts`
    - [ ] สร้าง key สำหรับ MinIO และนำไปบันทึกในข้อมูลไฟล์
    - [ ] กำหนดรูปแบบการตั้งชื่อ bucket และ object key ที่เหมาะสม
    - [ ] เพิ่มการรองรับ transaction สำหรับการอัปเดตฐานข้อมูล
- [ ] สร้าง Endpoint API สำหรับ Presigned URL (เกณฑ์ 1, 4, 5)
    - [ ] สร้าง Endpoint **POST /files/{id}/presigned-url** ใน `files.routes.ts`
    - [ ] เพิ่มการตรวจสอบ Schema ของ ElysiaJS
    - [ ] สร้างระบบจัดการข้อผิดพลาดสำหรับกรณีที่ MinIO ไม่พร้อมใช้งาน
    - [ ] ส่งคืน response ที่มี URL, method, และ headers ที่จำเป็น
- [ ] เพิ่ม Unit tests ที่ครอบคลุม (เกณฑ์ 8)
    - [ ] ทดสอบ `minio.provider.ts` โดยใช้ mock MinIO client
    - [ ] ทดสอบ logic การสร้าง Presigned URL ใน `files.service.ts`
    - [ ] ทดสอบ API Endpoint โดยใช้ mock MinIO service
    - [ ] ให้มี Code coverage 80% สำหรับโค้ดที่เกี่ยวข้องกับ MinIO

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 2.1 ได้สร้างระบบ CRUD สำหรับข้อมูลไฟล์ด้วย Prisma และ Endpoint API ด้วย ElysiaJS ไว้แล้ว ทำให้เรามีพื้นฐานที่ดีสำหรับการเพิ่มการเชื่อมต่อกับ MinIO

#### โครงสร้าง Data Model ของไฟล์
* **`id`**: UUID - Primary key ที่ใช้สร้าง MinIO key
* **`filename`**: String (ไม่เกิน 255 ตัวอักษร) - ใช้ในการตั้งชื่อไฟล์ใน MinIO
* **`filetype`**: String (ไม่เกิน 100 ตัวอักษร) - MIME type ที่ใช้สร้าง Presigned URL
* **`fileSize`**: BigInt - ใช้ตรวจสอบขนาดไฟล์
* **`minioKey`**: String (ไม่เกิน 500 ตัวอักษร) - Key เฉพาะสำหรับ MinIO
* **`uploadStatus`**: Enum - สถานะการอัปโหลดที่ถูกอัปเดตในกระบวนการ

#### รายละเอียดการเชื่อมต่อ MinIO
* **การตั้งค่า:**
    * ใช้ `MINIO_ENDPOINT` สำหรับ URL
    * ใช้ `MINIO_ACCESS_KEY` และ `MINIO_SECRET_KEY` สำหรับการเข้าถึง
    * กำหนดชื่อ bucket ผ่าน `MINIO_BUCKET_NAME`
    * ใช้ MinIO JavaScript SDK อย่างเป็นทางการเพื่อความปลอดภัย
* **การทำงานหลัก:**
    * สร้าง Presigned URL สำหรับ PUT operations ที่มีอายุ 5 นาที
    * มีระบบจัดการข้อผิดพลาดหาก MinIO ไม่พร้อมใช้งาน (ส่ง HTTP 500)
    * SDK จะจัดการ Connection pooling และ timeout ให้เอง

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test** ที่มีมาในตัว พร้อมรองรับ TypeScript
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน service และ business logic
    * มีการเขียน Unit test สำหรับชั้น provider, service, และ routes
* **การจำลองข้อมูล:** ใช้ Bun’s built-in mock สำหรับการจำลอง MinIO client
* **รูปแบบการจัดเรียง Test:**
    * **Provider tests:** `minio.provider.test.ts`
    * **Service tests:** `files.service.test.ts`
    * **Route tests:** `files.routes.test.ts`
    * ใช้รูปแบบ **AAA** (Arrange, Act, Assert) ในการเขียน test

---
