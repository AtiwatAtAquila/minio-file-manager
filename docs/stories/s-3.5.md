แน่นอนค่ะ นี่คือเนื้อหาที่ตัดส่วนที่เป็นงานของ AI ออกไปทั้งหมดแล้วค่ะ

-----

# Story 3.5: การค้นหาไฟล์ตามสิทธิ์ของผู้ดูแลระบบ

## สถานะ

แบบร่าง

## Story

**ในฐานะ** ผู้ดูแลระบบ 
**ฉันต้องการ** ค้นหาไฟล์โดยอิงตามรูปแบบการเข้าถึงของแต่ละ Role 
**เพื่อที่จะ** สามารถตรวจสอบสิทธิ์และทำความเข้าใจว่า Role ใดเข้าถึงไฟล์ใดได้บ้าง

## เกณฑ์การยอมรับ

1.  ปลายทาง GET /roles/{roleName}/files ต้องแสดงรายการไฟล์ทั้งหมดที่ Role นั้นเข้าถึงได้
2.  ปลายทาง GET /files/by-role ต้องยอมรับพารามิเตอร์ ?role= เพื่อใช้ในการกรองข้อมูลตาม Role
3.  ปลายทางสำหรับผู้ดูแลระบบทั้งหมดต้องจำกัดสิทธิ์เฉพาะผู้ใช้ที่มี Role "Boss" เท่านั้น
4.  ผลลัพธ์ที่ได้ต้องมีข้อมูลไฟล์ (File Metadata) และ Timestamp ที่ระบุว่าสิทธิ์ถูกให้เมื่อไหร่
5.  รองรับการแบ่งหน้า (Pagination) สำหรับชุดข้อมูลขนาดใหญ่ พร้อมแสดงข้อมูล Metadata ที่ถูกต้อง
6.  ปรับปรุงประสิทธิภาพการค้นหาด้วยการใช้ Database Index ที่เหมาะสม
7.  รูปแบบการตอบกลับ (Response Format) ต้องสอดคล้องกับปลายทาง (Endpoint) ที่แสดงรายการไฟล์อื่นๆ
8.  ระบบความปลอดภัยต้องมั่นใจว่าผู้ใช้ที่ไม่มี Role "Boss" จะไม่สามารถเข้าถึงการค้นหาของผู้ดูแลระบบได้

## งาน / งานย่อย

  - [ ] สร้าง Middleware สำหรับตรวจสอบ Role "Boss" (AC: 3, 8)
      - [ ] สร้างไฟล์ `src/features/admin/admin.middleware.ts` พร้อมโค้ดสำหรับตรวจสอบ Role "Boss"
      - [ ] สร้างฟังก์ชัน Middleware ชื่อ `checkBossRole()` โดยใช้ UserContext จากส่วน Header ของการยืนยันตัวตน
      - [ ] ตรวจสอบว่าผู้ใช้มี Role "Boss" อยู่ใน array ของ Role จาก header ชื่อ x-user-roles
      - [ ] หากผู้ใช้ไม่มี Role "Boss" ให้คืนค่า HTTP 403 พร้อมข้อความแจ้งข้อผิดพลาดที่ชัดเจนและ Correlation ID
      - [ ] นำ Middleware ไปใช้กับปลายทางสำหรับผู้ดูแลระบบทั้งหมดที่ต้องใช้สิทธิ์ "Boss"
      - [ ] จัดรูปแบบการตอบกลับข้อผิดพลาดให้เป็นไปตาม Schema ของ ErrorResponse
  - [ ] พัฒนา Repository Method สำหรับค้นหาไฟล์ตาม Role (AC: 1, 2, 4, 6)
      - [ ] แก้ไขไฟล์ `src/features/files/files.repository.ts` และเพิ่ม Method สำหรับการค้นหาของผู้ดูแลระบบ
      - [ ] สร้าง Method `findFilesByRole()` โดยใช้ Prisma join กับตาราง FileRolePermissions
      - [ ] สร้าง Method `getFilesByRoleParameter()` สำหรับการกรองข้อมูลด้วยพารามิเตอร์ query
      - [ ] ใช้ Prisma query ที่มีการ Join ระหว่างตาราง Files และ FileRolePermissions เพื่อเพิ่มประสิทธิภาพ
      - [ ] ใส่ข้อมูล Timestamp ของการให้สิทธิ์ (grantedAt) ไว้ใน Object ของไฟล์ที่ตอบกลับ
      - [ ] เพิ่มประสิทธิภาพการค้นหาด้วยการใช้ Index ที่มีอยู่แล้วบนคอลัมน์ `roleName` และ `fileId`
      - [ ] รองรับการแบ่งหน้าด้วยการจัดการ offset/limit สำหรับชุดข้อมูลขนาดใหญ่
  - [ ] สร้าง Service Method สำหรับการค้นหาไฟล์ของผู้ดูแลระบบ (AC: 1, 2, 4, 5, 7)
      - [ ] แก้ไขไฟล์ `src/features/files/files.service.ts` พร้อมเพิ่ม Operation สำหรับการค้นหาของผู้ดูแลระบบ
      - [ ] สร้าง Method `getFilesBySpecificRole()` สำหรับการแสดงรายการไฟล์ตาม Role
      - [ ] สร้าง Method `getFilesByRoleQuery()` สำหรับการกรองข้อมูลด้วยพารามิเตอร์ query
      - [ ] ใส่ข้อมูลไฟล์แบบเต็มพร้อม Timestamp ของสิทธิ์ลงในส่วนที่ตอบกลับ
      - [ ] รองรับการแบ่งหน้าด้วยโครงสร้าง Metadata ที่สอดคล้องกับปลายทางที่มีอยู่
      - [ ] ตรวจสอบให้แน่ใจว่ารูปแบบการตอบกลับตรงกับรูปแบบการแสดงรายการไฟล์ที่มีอยู่
      - [ ] จัดการกรณีพิเศษสำหรับ Role ที่ไม่มีอยู่จริงและชุดสิทธิ์ที่ว่างเปล่า
  - [ ] สร้างปลายทาง REST API สำหรับผู้ดูแลระบบ (AC: 1, 2, 3, 8)
      - [ ] สร้างไฟล์ `src/features/admin/admin.routes.ts` พร้อมปลายทางที่จำกัดสิทธิ์เฉพาะ "Boss"
      - [ ] สร้างปลายทาง GET /roles/{roleName}/files พร้อมการตรวจสอบความถูกต้องของพารามิเตอร์ Role
      - [ ] สร้างปลายทาง GET /files/by-role พร้อมรองรับพารามิเตอร์ query ?role=
      - [ ] ใช้ Middleware ที่ตรวจสอบ Role "Boss" เพื่อปกป้องปลายทางของผู้ดูแลระบบทั้งหมด
      - [ ] ตรวจสอบให้แน่ใจว่ามีการตอบกลับข้อผิดพลาดและ Correlation ID อย่างสม่ำเสมอ
      - [ ] กำหนดพารามิเตอร์การแบ่งหน้าให้เข้ากันได้กับปลายทางไฟล์ที่มีอยู่
      - [ ] ตรวจสอบว่าชื่อ Role มีอยู่ในฐานข้อมูลก่อนทำการค้นหาสิทธิ์
  - [ ] สร้าง Unit Test แบบครบวงจร (AC: 1, 2, 3, 4, 5, 6, 7, 8)
      - [ ] สร้างไฟล์ `src/features/admin/__tests__/admin.middleware.test.ts`
      - [ ] แก้ไขและเพิ่ม Test ในไฟล์ `src/features/files/__tests__/files.service.test.ts`
      - [ ] แก้ไขและเพิ่ม Test ในไฟล์ `src/features/files/__tests__/files.repository.test.ts`
      - [ ] สร้างไฟล์ `src/features/admin/__tests__/admin.routes.test.ts`
      - [ ] ทดสอบการตรวจสอบ Role "Boss" ด้วยการผสมผสาน Role ของผู้ใช้ที่แตกต่างกัน
      - [ ] ทดสอบว่าผู้ใช้ที่ไม่มี Role "Boss" ได้รับ HTTP 403 สำหรับปลายทางของผู้ดูแลระบบ
      - [ ] ทดสอบการแสดงรายการไฟล์ตาม Role โดยมี Timestamp ของสิทธิ์
      - [ ] ทดสอบฟังก์ชันการกรองไฟล์ตามพารามิเตอร์ query
      - [ ] ทดสอบการจัดการการแบ่งหน้าสำหรับชุดข้อมูลไฟล์และสิทธิ์ขนาดใหญ่
      - [ ] จำลอง UserContext ด้วย Role "Boss" และ Role อื่นๆ เพื่อการทดสอบที่ครอบคลุม

## Dev Notes

### ข้อมูลเชิงลึกจาก Story ก่อนหน้า

Story 3.1-3.4 ได้วางรากฐานของ RBAC (การควบคุมการเข้าถึงตาม Role) อย่างสมบูรณ์: มีการยืนยันตัวตนด้วย Caddy พร้อมการแยก UserContext, การจัดการ Role พร้อมการอนุญาตจาก Boss, ระบบสิทธิ์ไฟล์พร้อมตาราง FileRolePermission และการบังคับใช้การควบคุมการเข้าถึงด้วย Middleware ที่จัดการสิทธิ์ Story นี้จะเพิ่มความสามารถให้ผู้ใช้ที่มี Role "Boss" สามารถตรวจสอบและสืบค้นระบบสิทธิ์เพื่อการกำกับดูแลและการปฏิบัติตามกฎระเบียบ

### บริบททางสถาปัตยกรรมทางเทคนิค

**ElysiaJS Framework** [ที่มา: architecture/tech-stack.md]:

  - ใช้ ElysiaJS 0.8+ สำหรับ REST API framework พร้อมการสร้าง OpenAPI อัตโนมัติ
  - มีระบบตรวจสอบ Schema ในตัวสำหรับการตรวจสอบความถูกต้องของคำขอ/การตอบกลับ
  - ใช้ระบบ Middleware สำหรับการตรวจสอบ Role "Boss" และการควบคุมการเข้าถึงของผู้ดูแลระบบ
  - ผสานการทำงานกับ TypeScript พร้อมการตรวจสอบประเภทข้อมูลที่เข้มงวด

**การดำเนินการกับฐานข้อมูล** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - ต้องใช้ Repository Pattern สำหรับการดำเนินการกับฐานข้อมูลทั้งหมด
  - ต้องใช้ Prisma transaction สำหรับการดำเนินการกับหลายตาราง
  - การ Query ฐานข้อมูลต้องใช้ Prisma ORM พร้อมระบบความปลอดภัยของประเภทข้อมูล
  - การจัดการการเข้าถึงพร้อมกัน (Concurrent Access) ผ่านกลไกในตัวของ Prisma

### Data Models

**Administrative File Response with Permissions** [ที่มา: architecture/data-models.md\#file]:

```typescript
interface AdminFileWithPermissions {
  id: string;
  filename: string;
  filetype: string;
  fileSize: bigint;
  uploadedAt: Date;
  minioKey: string;
  uploadStatus: 'pending' | 'completed' | 'failed';
  permissions: {
    roleName: string;
    grantedAt: Date;
    grantedBy: string;
  }[];
}
```

**Admin Query Response Types**:

```typescript
interface AdminFileListResponse {
  files: AdminFileWithPermissions[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
  metadata: {
    queriedRole: string;
    totalPermissions: number;
  };
}
```

### Database Schema

**Optimized Administrative Queries** [ที่มา: architecture/database-schema.md]:

  - ตาราง FileRolePermission จะมี Index บนคอลัมน์ `roleName`, `fileId` เพื่อการค้นหาของผู้ดูแลระบบที่รวดเร็ว
  - ใช้ Prisma joins ระหว่างตาราง Files และ FileRolePermissions เพื่อการ Query ตาม Role อย่างมีประสิทธิภาพ
  - มี Index บน `grantedAt` และ `grantedBy` สำหรับการตรวจสอบ Audit Trail และ Query ตาม Timestamp ของสิทธิ์
  - ตาราง Role มี Index บน `name` สำหรับการตรวจสอบ Role อย่างมีประสิทธิภาพก่อนทำการ Query สิทธิ์

### File Locations

**โครงสร้าง Source Tree** [ที่มา: architecture/source-tree.md]:

  - **Admin Middleware**: `src/features/admin/admin.middleware.ts` - สำหรับตรวจสอบ Role "Boss"
  - **Admin Routes**: `src/features/admin/admin.routes.ts` - สำหรับปลายทางของผู้ดูแลระบบ
  - **Repository Updates**: `src/features/files/files.repository.ts` - สำหรับ Method การ Query ของผู้ดูแลระบบ
  - **Service Updates**: `src/features/files/files.service.ts` - สำหรับ Logic ทางธุรกิจของผู้ดูแลระบบ
  - **Tests**: `src/features/admin/__tests__/`, `src/features/files/__tests__/` - สำหรับ Test Suite ที่อัปเดตแล้ว

### API Specifications

**Administrative Endpoints** [ที่มา: architecture/rest-api-specification.md]:

  - **GET /roles/{roleName}/files**: แสดงรายการไฟล์ทั้งหมดที่ Role นั้นเข้าถึงได้ พร้อม Metadata ของสิทธิ์
  - **GET /files/by-role?role={roleName}**: การกรองไฟล์ตาม Role ด้วยพารามิเตอร์ query
  - **การจำกัดสิทธิ์ Role "Boss"**: ปลายทางของผู้ดูแลระบบทั้งหมดต้องใช้ Role "Boss" ใน array ของ Role ของผู้ใช้
  - **การแบ่งหน้าอย่างสอดคล้อง**: ใช้โครงสร้างการแบ่งหน้าเดียวกับปลายทางที่แสดงรายการไฟล์ที่มีอยู่

**รูปแบบการตอบกลับที่ปรับปรุงแล้วสำหรับการ Query ของผู้ดูแลระบบ**:

  - ประกอบด้วยข้อมูลไฟล์แบบเต็มพร้อม Timestamp ของสิทธิ์
  - Metadata ของการแบ่งหน้าที่สอดคล้องกับปลายทางที่มีอยู่
  - Metadata ของการ Query ที่ระบุว่า Query Role ใดไปและจำนวนสิทธิ์ทั้งหมด

### Technical Constraints

**ข้อกำหนดด้านประสิทธิภาพ** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - การ Query ฐานข้อมูลต้องใช้ Prisma joins เพื่อการ Query ของผู้ดูแลระบบที่มีประสิทธิภาพ
  - ปลายทางของผู้ดูแลระบบต้องจัดการกับชุดข้อมูลขนาดใหญ่ด้วยการแบ่งหน้าที่เหมาะสม
  - การเพิ่มประสิทธิภาพการ Query โดยใช้ Database Index ที่มีอยู่บน FileRolePermissions
  - ลดจำนวนการเรียกฐานข้อมูลต่อคำขอของผู้ดูแลระบบ

**ข้อกำหนดด้านความปลอดภัย**:

  - ปลายทางของผู้ดูแลระบบถูกจำกัดสิทธิ์เฉพาะ Role "Boss" เท่านั้น
  - ผู้ใช้ที่ไม่มี Role "Boss" ต้องได้รับ HTTP 403 พร้อมข้อความแจ้งข้อผิดพลาดที่ชัดเจน
  - ต้องไม่มีการรั่วไหลของข้อมูลเกี่ยวกับ Role หรือไฟล์สำหรับผู้ใช้ที่ไม่มี Role "Boss"
  - มีการติดตาม Correlation ID สำหรับการดำเนินการของผู้ดูแลระบบทั้งหมดและ Audit Trail
  - การตรวจสอบ Role จะเกิดขึ้นก่อนการ Query ฐานข้อมูลใดๆ

**การเพิ่มประสิทธิภาพฐานข้อมูล**:

  - ใช้ Prisma `include` และ `where` clause เพื่อการ Join ข้อมูลสิทธิ์อย่างมีประสิทธิภาพ
  - ใช้ประโยชน์จาก Index ของ FileRolePermission บนคอลัมน์ roleName สำหรับการ Query ตาม Role
  - ใช้ Index ของตาราง Role ที่มีอยู่บนคอลัมน์ name สำหรับการตรวจสอบ Role
  - รองรับการแบ่งหน้าเพื่อจัดการกับชุดผลลัพธ์ขนาดใหญ่ได้อย่างมีประสิทธิภาพ

### Testing

**Framework และตำแหน่งไฟล์** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **Framework**: Bun Test (มีมาให้ในตัว) พร้อมรองรับ TypeScript
  - **รูปแบบชื่อไฟล์**: ไฟล์ `*.test.ts` อยู่ร่วมกับไฟล์ต้นฉบับ
  - **ตำแหน่ง**: Tests อยู่ใน `src/features/admin/__tests__/` และอัปเดต Tests ใน `src/features/files/__tests__/`
  - **Mocking**: ใช้ฟังก์ชัน Mock ในตัวของ Bun สำหรับ Prisma client และ ElysiaJS context

**ข้อกำหนดด้าน Coverage** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - Code coverage 80% สำหรับ Middleware และ Business Logic ของผู้ดูแลระบบ
  - Unit Test สำหรับสถานการณ์การตรวจสอบ Role "Boss" และการ Query ของผู้ดูแลระบบทั้งหมด
  - ทดสอบการ Query ไฟล์ตาม Role ในชุดสิทธิ์ที่แตกต่างกัน
  - Mock การดำเนินการกับฐานข้อมูลและ Object ของคำขอ/การตอบกลับ HTTP

**รูปแบบการจัดระเบียบ Test** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **Test Middleware ของผู้ดูแลระบบ**: `admin.middleware.test.ts` - ทดสอบการตรวจสอบ Role "Boss" และการตอบกลับ 403
  - **Test Repository**: `files.repository.test.ts` - ทดสอบ Method การ Query ของผู้ดูแลระบบ
  - **Test Service**: `files.service.test.ts` - ทดสอบ Business Logic ของผู้ดูแลระบบและรูปแบบการตอบกลับ
  - **Test Routes**: `admin.routes.test.ts` - ทดสอบการทำงานร่วมกันของปลายทางกับ Middleware ของ Boss
  - ทำตามรูปแบบ AAA (Arrange, Act, Assert)

**ข้อกำหนด Test ที่เจาะจง**:

  - ทดสอบการตรวจสอบ Role "Boss" ด้วยการผสมผสาน Role ของผู้ใช้ที่แตกต่างกัน (มี/ไม่มี Boss)
  - ทดสอบว่าผู้ใช้ที่ไม่มี Role "Boss" ได้รับ HTTP 403 สำหรับปลายทางของผู้ดูแลระบบทั้งหมด
  - ทดสอบการแสดงรายการไฟล์ตาม Role ที่เจาะจง รวมถึง Timestamp ของสิทธิ์
  - ทดสอบการกรองตามพารามิเตอร์ query ด้วย Role ที่มีอยู่และไม่มีอยู่จริง
  - ทดสอบการจัดการการแบ่งหน้าสำหรับการ Query ของผู้ดูแลระบบที่มีชุดข้อมูลขนาดใหญ่
  - ทดสอบความสอดคล้องของรูปแบบการตอบกลับกับปลายทางที่แสดงรายการไฟล์ที่มีอยู่
  - ทดสอบกรณีพิเศษ: Role ที่ไม่มีอยู่จริง, Role ที่ไม่มีสิทธิ์ในไฟล์, ชุดผลลัพธ์ว่างเปล่า
  - ทดสอบการจัดการข้อผิดพลาดและการคงอยู่ของ Correlation ID ในการดำเนินการของผู้ดูแลระบบ
  - Mock UserContext ด้วย array ของ Role "Boss" และ Role อื่นๆ เพื่อการทดสอบการเข้าถึงที่ครอบคลุม

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | สร้าง Story เริ่มต้นสำหรับการ Query ไฟล์ตาม Role ของผู้ดูแลระบบ | Scrum Master |


