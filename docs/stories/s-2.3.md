---
## เรื่องที่ 2.3: การแสดงรายการไฟล์แบบแบ่งหน้าพร้อมระบบค้นหา

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะผู้ใช้งาน API** ผมต้องการดึงรายการไฟล์แบบแบ่งหน้า (pagination) พร้อมความสามารถในการค้นหา เพื่อให้ผมสามารถเรียกดูและค้นหาไฟล์ในระบบได้อย่างมีประสิทธิภาพ

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **GET /files** ต้องส่งคืนรายการไฟล์แบบแบ่งหน้า พร้อมขนาดหน้าที่กำหนดได้
2.  สามารถใช้ Query parameter **?search={filename}** เพื่อกรองไฟล์ตามชื่อไฟล์ได้บางส่วน
3.  ข้อมูลการแบ่งหน้าต้องมีข้อมูลเมตา เช่น จำนวนไฟล์ทั้งหมด, หน้าปัจจุบัน, จำนวนหน้ารวม, และสถานะว่ามีหน้าถัดไป/ก่อนหน้าหรือไม่
4.  รายการไฟล์จะถูกเรียงตาม **uploadedAt** (ไฟล์ล่าสุดมาก่อน) เป็นค่าเริ่มต้น
5.  ระบบค้นหาต้องใช้การค้นหาในฐานข้อมูลด้วย **Prisma** และใช้ Index ที่เหมาะสม
6.  ข้อมูลที่ส่งกลับต้องมีข้อมูลไฟล์ทั้งหมดในรูปแบบที่สอดคล้องกัน
7.  หากไม่มีผลลัพธ์การค้นหา ต้องส่งคืนโครงสร้างที่ถูกต้องพร้อมกับ Array ว่างและข้อมูลการแบ่งหน้า
8.  Query parameters ต้องถูกตรวจสอบความถูกต้อง และส่งข้อความผิดพลาดที่เหมาะสมหากค่าไม่ถูกต้อง

### งานหลัก / งานย่อย

- [ ] สร้าง logic สำหรับการแสดงรายการไฟล์แบบแบ่งหน้า (เกณฑ์ 1, 4, 5)
    - [ ] สร้างฟังก์ชันตัวช่วยสำหรับ pagination ใน `shared/utils/pagination.ts`
    - [ ] เพิ่มเมธอดการแสดงรายการแบบแบ่งหน้าใน `files.service.ts`
    - [ ] ใช้ Prisma query ที่มีการเรียงลำดับตาม `uploadedAt` แบบมากไปน้อย
    - [ ] เพิ่มการตรวจสอบความถูกต้องและกำหนดขีดจำกัดของขนาดหน้า
- [ ] เพิ่มระบบค้นหาในชั้น Service (เกณฑ์ 2, 5)
    - [ ] สร้างการค้นหาตามชื่อไฟล์โดยใช้ Prisma `contains` filter
    - [ ] เพิ่มการตรวจสอบความถูกต้องของพารามิเตอร์ค้นหา
    - [ ] ใช้ Index ของ `filename` เพื่อเพิ่มประสิทธิภาพ
- [ ] สร้าง Endpoint **GET /files** พร้อม Query parameters (เกณฑ์ 1, 2, 8)
    - [ ] สร้าง Route `GET /files` ใน `files.routes.ts`
    - [ ] เพิ่ม ElysiaJS Schema สำหรับตรวจสอบ Query parameter
    - [ ] เขียนโค้ดสำหรับแยกพารามิเตอร์ pagination และ search
    - [ ] สร้างการตอบกลับข้อผิดพลาดที่เหมาะสมสำหรับพารามิเตอร์ที่ไม่ถูกต้อง
- [ ] สร้างการตอบกลับพร้อมข้อมูลเมตา (เกณฑ์ 3, 6, 7)
    - [ ] สร้างประเภทข้อมูลสำหรับการตอบกลับ pagination ที่มีข้อมูลเมตา
    - [ ] คำนวณจำนวนหน้ารวม และสถานะว่ามีหน้าถัดไป/ก่อนหน้า
    - [ ] ตรวจสอบให้แน่ใจว่ารูปแบบข้อมูลไฟล์ที่ส่งกลับสอดคล้องกัน
    - [ ] จัดการกรณีที่ไม่มีผลลัพธ์ด้วยโครงสร้างที่ถูกต้อง
- [ ] เพิ่ม Unit tests ที่ครอบคลุม (เกณฑ์ทั้งหมด)
    - [ ] ทดสอบ logic pagination ใน `shared/utils/pagination.test.ts`
    - [ ] ทดสอบการแบ่งหน้าและการค้นหาใน `files.service.test.ts`
    - [ ] ทดสอบ API Endpoint ด้วยพารามิเตอร์ที่หลากหลายใน `files.routes.test.ts`
    - [ ] ให้มี Code coverage 80% สำหรับฟังก์ชันการแบ่งหน้าและการค้นหา

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 2.1 ได้สร้างระบบ CRUD สำหรับข้อมูลไฟล์ด้วย Prisma และ 2.2 ได้เพิ่มการเชื่อมต่อ MinIO แล้ว ตอนนี้เรามีโครงสร้างไฟล์, รูปแบบการตรวจสอบ, และ Schema ฐานข้อมูลที่พร้อมสำหรับการสร้างระบบแสดงรายการและการค้นหาที่มีประสิทธิภาพ

#### โครงสร้าง Data Model ของไฟล์
* **`id`**: UUID - Primary key สำหรับการตอบกลับ API
* **`filename`**: String (ไม่เกิน 255 ตัวอักษร) - ใช้สำหรับการค้นหาด้วย `contains` query
* **`uploadedAt`**: DateTime - ใช้เป็นหลักในการเรียงลำดับ (ล่าสุดมาก่อน)

#### รายละเอียด API
* **Endpoint สำหรับแสดงรายการไฟล์:**
    * **`GET /files`**: แสดงรายการไฟล์พร้อม pagination และการกรองตามบทบาท (role-based filtering)
    * รองรับ Query parameters: `page`, `limit`, `search`
    * Response มีข้อมูลเมตาการแบ่งหน้าแบบครบถ้วน

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test** ที่มีมาในตัว
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน service และ business logic
    * Unit test สำหรับฟังก์ชันช่วย, service และ route
* **การจำลองข้อมูล:** ใช้ mock Prisma client สำหรับการทดสอบในชั้น service
* **รูปแบบการจัดเรียง Test:**
    * **Pagination utils tests:** `pagination.test.ts`
    * **Service tests:** `files.service.test.ts`
    * **Route tests:** `files.routes.test.ts`
    * ใช้รูปแบบ **AAA** (Arrange, Act, Assert)
