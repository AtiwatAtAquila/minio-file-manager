---
## เรื่องที่ 3.2: การจัดการบทบาท (Role Management) แบบ CRUD

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะผู้ดูแลระบบ (system administrator)** ผมต้องการความสามารถในการจัดการบทบาทผ่าน **REST API** เพื่อให้ผมสามารถสร้าง, แก้ไข, และลบบทบาทเพื่อจัดระเบียบสิทธิ์การเข้าถึงไฟล์

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **GET /roles** ส่งคืนรายการบทบาททั้งหมดพร้อมข้อมูลเมตา (id, name, createdAt)
2.  Endpoint **POST /roles** สามารถสร้างบทบาทใหม่ได้ (จำกัดเฉพาะผู้ใช้ที่มีบทบาท "Boss")
3.  Endpoint **PUT /roles/{id}** สามารถอัปเดตชื่อบทบาทได้พร้อมการตรวจสอบความถูกต้องที่เหมาะสม
4.  Endpoint **DELETE /roles/{id}** สามารถลบบทบาทได้ และจะลบสิทธิ์การเข้าถึงไฟล์ที่เกี่ยวข้องทั้งหมดด้วย
5.  มีการตรวจสอบความถูกต้องของชื่อบทบาทเพื่อให้แน่ใจว่าไม่ซ้ำกันและใช้ได้เฉพาะตัวอักษรที่ปลอดภัย
6.  การจำกัดสิทธิ์สำหรับบทบาท "Boss" จะถูกบังคับใช้ผ่าน Middleware ที่ตรวจสอบบทบาทของผู้ใช้จาก Header
7.  ผู้ใช้ที่ไม่มีบทบาท "Boss" จะได้รับ **HTTP 403** เมื่อพยายามสร้างบทบาท
8.  การดำเนินการกับฐานข้อมูลต้องสามารถรองรับการเข้าถึงพร้อมกันและรักษาความสอดคล้องกันของข้อมูล

### งานหลัก / งานย่อย

- [ ] สร้างโครงสร้างสำหรับ validation และ types ของบทบาท (เกณฑ์ 5)
    - [ ] สร้างไฟล์ `src/features/roles/roles.types.ts` พร้อม Domain types สำหรับบทบาท
    - [ ] สร้างไฟล์ `src/features/roles/roles.validation.ts` พร้อม validation schemas
    - [ ] เขียนโค้ดตรวจสอบชื่อบทบาทว่าไม่ซ้ำกันและปลอดภัย
    - [ ] ใช้ ElysiaJS schema validation สำหรับการตรวจสอบ request/response
- [ ] สร้าง Repository สำหรับการดำเนินการกับฐานข้อมูล (เกณฑ์ 8)
    - [ ] สร้างไฟล์ `src/features/roles/roles.repository.ts` พร้อมการทำงานกับ Prisma
    - [ ] เขียนเมธอด `findAll()` สำหรับ Endpoint `GET /roles`
    - [ ] เขียนเมธอด `create()` พร้อมการจัดการชื่อที่ไม่ซ้ำกัน
    - [ ] เขียนเมธอด `update()` พร้อมการป้องกันการเข้าถึงพร้อมกัน
    - [ ] เขียนเมธอด `delete()` พร้อมสั่งลบสิทธิ์การเข้าถึงไฟล์ที่เกี่ยวข้องทั้งหมด
    - [ ] ใช้ Prisma transactions สำหรับการทำงานกับหลายตาราง
- [ ] สร้าง Business logic ในชั้น Service สำหรับบทบาท (เกณฑ์ 1, 3, 4)
    - [ ] สร้างไฟล์ `src/features/roles/roles.service.ts` พร้อม Business logic
    - [ ] เขียนเมธอด `getAllRoles()` เพื่อส่งคืนข้อมูลบทบาท
    - [ ] เขียนเมธอด `createRole()` พร้อมการตรวจสอบความถูกต้องและชื่อที่ไม่ซ้ำกัน
    - [ ] เขียนเมธอด `updateRole()` พร้อมการตรวจสอบชื่อ
    - [ ] เขียนเมธอด `deleteRole()` พร้อมจัดการการลบสิทธิ์ที่เกี่ยวข้อง
    - [ ] จัดการข้อผิดพลาดจากฐานข้อมูลและส่งคืน HTTP status code ที่เหมาะสม
- [ ] สร้าง Middleware สำหรับการตรวจสอบบทบาท "Boss" (เกณฑ์ 2, 6, 7)
    - [ ] สร้างไฟล์ `src/features/admin/admin.middleware.ts` สำหรับตรวจสอบบทบาท "Boss"
    - [ ] ดึงบทบาทของผู้ใช้จาก request context (ซึ่งถูกตั้งค่าโดย auth middleware)
    - [ ] ตรวจสอบว่ามีบทบาท "Boss" อยู่ใน array ของบทบาทผู้ใช้
    - [ ] ส่งคืน **HTTP 403** สำหรับผู้ใช้ที่ไม่มีบทบาท "Boss" พร้อมข้อความที่ชัดเจน
    - [ ] นำ Middleware นี้ไปใช้กับ Endpoint สำหรับการสร้างบทบาทและการจัดการของผู้ดูแลระบบ
- [ ] สร้าง Endpoint REST API สำหรับบทบาท (เกณฑ์ 1, 2, 3, 4)
    - [ ] สร้างไฟล์ `src/features/roles/roles.routes.ts` พร้อม Endpoint ของ ElysiaJS
    - [ ] สร้าง Endpoint `GET /roles` เพื่อส่งคืนข้อมูลบทบาท
    - [ ] สร้าง Endpoint `POST /roles` พร้อมใช้ Boss role middleware
    - [ ] สร้าง Endpoint `PUT /roles/{id}` พร้อมการตรวจสอบความถูกต้อง
    - [ ] สร้าง Endpoint `DELETE /roles/{id}` พร้อมจัดการการลบแบบ cascade
    - [ ] ลงทะเบียน Routes ใน `src/app.ts` พร้อมการเชื่อมโยง Middleware ที่ถูกต้อง
- [ ] สร้าง Unit tests ที่ครอบคลุม (เกณฑ์ 1, 2, 3, 4, 5, 6, 7, 8)
    - [ ] สร้างไฟล์ `src/features/roles/__tests__/roles.service.test.ts`
    - [ ] สร้างไฟล์ `src/features/roles/__tests__/roles.repository.test.ts`
    - [ ] สร้างไฟล์ `src/features/roles/__tests__/roles.routes.test.ts`
    - [ ] สร้างไฟล์ `src/features/admin/__tests__/admin.middleware.test.ts`
    - [ ] ทดสอบการทำงาน CRUD ของบทบาทที่สำเร็จ
    - [ ] ทดสอบการอนุญาตของบทบาท "Boss" และการตอบกลับ HTTP 403
    - [ ] ทดสอบการตรวจสอบชื่อบทบาทและข้อจำกัดเรื่องชื่อไม่ซ้ำ
    - [ ] ทดสอบการลบสิทธิ์ไฟล์ที่เกี่ยวข้องทั้งหมดเมื่อลบบทบาท
    - [ ] Mock Prisma client และ ElysiaJS request context สำหรับการทดสอบ

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 3.1 ได้สร้างการแยกวิเคราะห์ Header ของ Caddy และแนบบริบทของผู้ใช้เข้ากับ request แล้ว ตอนนี้ข้อมูลผู้ใช้ (id, email, และ array ของบทบาท) สามารถเข้าถึงได้ในทุก request งานนี้จะใช้ข้อมูลดังกล่าวเป็นพื้นฐานในการสร้างระบบควบคุมสิทธิ์การเข้าถึงสำหรับผู้ดูแลระบบ

#### สถาปัตยกรรมทางเทคนิค
* **เฟรมเวิร์ก ElysiaJS:**
    * ElysiaJS มีระบบ Schema validation และ Middleware ในตัว
    * ใช้ TypeScript สำหรับการตรวจสอบประเภทอย่างเข้มงวด
* **การจัดการฐานข้อมูล:**
    * ใช้ Repository pattern สำหรับการดำเนินการกับฐานข้อมูลทั้งหมด
    * **Prisma transactions** เป็นสิ่งจำเป็นสำหรับงานที่เกี่ยวข้องกับหลายตาราง
    * มีการจัดการการเข้าถึงพร้อมกัน (concurrent access) ผ่านกลไกของ Prisma

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test** ที่มีมาในตัว
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน service และ repository
    * มี Unit test สำหรับการทำงาน CRUD ทั้งหมดและ logic การตรวจสอบสิทธิ์
* **การจำลองข้อมูล:** ใช้ Bun’s built-in mock สำหรับ Prisma client และ ElysiaJS context
* **รูปแบบการจัดเรียง Test:**
    * **Service tests:** `roles.service.test.ts`
    * **Repository tests:** `roles.repository.test.ts`
    * **Routes tests:** `roles.routes.test.ts`
    * **Admin middleware tests:** `admin.middleware.test.ts`
    * ใช้รูปแบบ **AAA** (Arrange, Act, Assert)
* **ข้อกำหนดการทดสอบเฉพาะ:**
    * ทดสอบการสร้าง, ดึง, อัปเดต, และลบบทบาทที่สำเร็จ
    * ทดสอบการอนุญาตของบทบาท "Boss" สำหรับการทำงานของผู้ดูแลระบบ
    * ทดสอบการตอบกลับ **HTTP 403** สำหรับผู้ใช้ที่ไม่มีบทบาท "Boss"
    * ทดสอบการตรวจสอบชื่อบทบาทและข้อจำกัดเรื่องชื่อไม่ซ้ำ
    * ทดสอบการลบสิทธิ์การเข้าถึงไฟล์ทั้งหมดเมื่อลบบทบาท
    * ทดสอบสถานการณ์การเข้าถึงพร้อมกันและการจัดการ transaction
    * ทดสอบการจัดการข้อผิดพลาดสำหรับ request ที่ไม่ถูกต้องและข้อผิดพลาดจากฐานข้อมูล
    * Mock `UserContext` ด้วยการผสมผสานบทบาทที่แตกต่างกัน
