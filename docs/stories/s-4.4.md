# Story 4.4: การทดสอบแบบ Unit Test และคุณภาพของโค้ด

## สถานะ

แบบร่าง

## Story

**ในฐานะ** นักพัฒนาที่ดูแลโค้ด
**ฉันต้องการ** การทดสอบแบบ Unit Test ที่ครอบคลุมและมาตรการด้านคุณภาพของโค้ด
**เพื่อที่จะ** สามารถแก้ไขและขยายระบบได้อย่างมั่นใจ

## เกณฑ์การยอมรับ

1.  มีการใช้ Unit Test สำหรับฟังก์ชัน Logic ทางธุรกิจและ Endpoint ของ API ทั้งหมด
2.  การดำเนินการกับฐานข้อมูลต้องได้รับการทดสอบด้วยการ Mock หรือใช้ฐานข้อมูลสำหรับทดสอบที่เหมาะสม
3.  การเชื่อมต่อกับ MinIO ต้องได้รับการทดสอบด้วยการจำลองบริการ MinIO
4.  Middleware การยืนยันตัวตนต้องได้รับการทดสอบด้วยสถานการณ์ Header ที่หลากหลาย
5.  Logic การบังคับใช้สิทธิ์ต้องได้รับการทดสอบอย่างละเอียดด้วยการผสมผสาน Role ที่แตกต่างกัน
6.  มีการสร้างรายงานความครอบคลุมของการทดสอบ (Test Coverage) และสามารถเข้าถึงได้
7.  เปิดใช้งาน TypeScript Strict Mode และต้องไม่มีข้อผิดพลาดด้าน Type
8.  มีการตั้งค่า Linting และ Formatting ของโค้ดให้มีมาตรฐานที่สอดคล้องกัน

## งาน / งานย่อย

  - [ ] สร้าง Unit Test ที่ครอบคลุมสำหรับ Logic ทางธุรกิจทั้งหมด (AC: 1)
      - [ ] สร้าง Unit Test สำหรับ `src/features/files/files.service.ts` เพื่อครอบคลุมการดำเนินการกับไฟล์ทั้งหมด
      - [ ] สร้าง Unit Test สำหรับ `src/features/roles/roles.service.ts` เพื่อครอบคลุมการจัดการ Role
      - [ ] สร้าง Unit Test สำหรับ `src/features/permissions/permissions.service.ts` เพื่อครอบคลุม Logic การจัดการสิทธิ์
      - [ ] สร้าง Unit Test สำหรับ `src/features/admin/admin.service.ts` เพื่อครอบคลุมการ Query ของผู้ดูแลระบบ
      - [ ] สร้าง Unit Test สำหรับ `src/features/health/health.service.ts` เพื่อครอบคลุมการตรวจสอบสถานะระบบ
      - [ ] ทดสอบทุก Method ของ Service ด้วยสถานการณ์ Input และ Edge Case ที่หลากหลาย
      - [ ] ทดสอบเส้นทางการจัดการข้อผิดพลาดในฟังก์ชัน Logic ทางธุรกิจทั้งหมด
      - [ ] ตรวจสอบให้แน่ใจว่า Code Coverage ของทุก Class ของ Service มีอย่างน้อย 80%
  - [ ] สร้างการทดสอบ Endpoint ของ API อย่างครอบคลุม (AC: 1)
      - [ ] สร้าง Route Test สำหรับ `src/features/files/files.routes.ts` เพื่อทดสอบ HTTP Method ทั้งหมด
      - [ ] สร้าง Route Test สำหรับ `src/features/roles/roles.routes.ts` เพื่อทดสอบ Endpoint ของ Role
      - [ ] สร้าง Route Test สำหรับ `src/features/permissions/permissions.routes.ts` เพื่อทดสอบ Endpoint ของสิทธิ์
      - [ ] สร้าง Route Test สำหรับ `src/features/admin/admin.routes.ts` เพื่อทดสอบ Endpoint ของผู้ดูแลระบบ
      - [ ] สร้าง Route Test สำหรับ `src/features/health/health.routes.ts` เพื่อทดสอบ Endpoint Health Check
      - [ ] ทดสอบการตรวจสอบคำขอ (Request Validation), การจัดรูปแบบการตอบกลับ, และการจัดการข้อผิดพลาด
      - [ ] ทดสอบข้อกำหนดด้านการยืนยันตัวตนและการอนุญาตสิทธิ์ในระดับ Route
      - [ ] Mock Dependency ภายนอกอย่างเหมาะสมสำหรับการทดสอบ Route แบบแยกส่วน
  - [ ] ทดสอบการดำเนินการกับฐานข้อมูลด้วยการ Mock (AC: 2)
      - [ ] สร้าง Unit Test สำหรับ `src/features/files/files.repository.ts` ด้วยการ Mock ฐานข้อมูล
      - [ ] สร้าง Unit Test สำหรับ `src/features/roles/roles.repository.ts` ด้วยการ Mock Prisma
      - [ ] สร้าง Unit Test สำหรับ `src/features/permissions/permissions.repository.ts` ด้วยการ Mock Transaction
      - [ ] ทดสอบการจัดการข้อจำกัดของฐานข้อมูลและสถานการณ์ข้อผิดพลาด
      - [ ] ทดสอบการทำ Transaction พร้อมสถานการณ์ Rollback
      - [ ] Mock Prisma Client อย่างถูกต้องโดยใช้ฟังก์ชัน Mock ในตัวของ Bun
      - [ ] ทดสอบ Repository Method ด้วยสถานการณ์ข้อมูลและ Edge Case ที่หลากหลาย
      - [ ] ตรวจสอบให้แน่ใจว่าการดำเนินการกับฐานข้อมูลได้รับการทดสอบโดยไม่ขึ้นกับฐานข้อมูลจริง
  - [ ] ทดสอบการเชื่อมต่อกับ MinIO ด้วยการ Mock (AC: 3)
      - [ ] สร้าง Unit Test สำหรับ `src/providers/minio/minio.provider.ts` ด้วยการ Mock MinIO Client
      - [ ] ทดสอบการดำเนินการอัปโหลด, ดาวน์โหลด, และลบไฟล์ด้วยการ Mock การตอบกลับ
      - [ ] ทดสอบสถานการณ์การจัดการข้อผิดพลาดของ MinIO (การเชื่อมต่อล้มเหลว, Timeout)
      - [ ] ทดสอบ Retry Logic ของ MinIO ด้วยสถานการณ์ความล้มเหลวและการกู้คืนที่หลากหลาย
      - [ ] Mock การตอบกลับของ MinIO Client สำหรับผลลัพธ์การดำเนินการที่แตกต่างกัน
      - [ ] ทดสอบการดำเนินการกับ Bucket และการตรวจสอบการเชื่อมต่อด้วยการ Mock บริการ MinIO
      - [ ] ตรวจสอบให้แน่ใจว่าการดำเนินการของ MinIO Provider ได้รับการทดสอบโดยไม่ขึ้นกับ MinIO ภายนอก
      - [ ] ทดสอบการตรวจสอบการตั้งค่า MinIO และการตั้งค่า Connection
  - [ ] ทดสอบ Middleware การยืนยันตัวตนอย่างครอบคลุม (AC: 4)
      - [ ] สร้าง Unit Test สำหรับ `src/features/auth/auth.middleware.ts` ด้วยการตรวจสอบ Header
      - [ ] ทดสอบการยืนยันตัวตนด้วย Header ของ Caddy ที่ถูกต้อง (x-user-id, x-user-email, x-user-roles)
      - [ ] ทดสอบสถานการณ์การยืนยันตัวตนล้มเหลวเมื่อ Header ขาดหายไป
      - [ ] ทดสอบสถานการณ์การยืนยันตัวตนล้มเหลวเมื่อ Header มีรูปแบบไม่ถูกต้อง
      - [ ] ทดสอบการดึงข้อมูล Role และการตรวจสอบความถูกต้องจาก Header x-user-roles
      - [ ] ทดสอบการตอบกลับข้อผิดพลาดและรหัสสถานะของ Middleware การยืนยันตัวตน
      - [ ] ทดสอบการคงอยู่ของ Correlation ID ตลอดกระบวนการยืนยันตัวตน
      - [ ] ทดสอบสถานการณ์ User Context และ Edge Case ที่หลากหลาย
  - [ ] ทดสอบการบังคับใช้สิทธิ์ (AC: 5)
      - [ ] สร้าง Unit Test สำหรับ Logic การจัดการสิทธิ์ด้วยการผสมผสาน Role ที่แตกต่างกัน
      - [ ] ทดสอบสิทธิ์ของ Role "Boss" สำหรับการดำเนินการของผู้ดูแลระบบ
      - [ ] ทดสอบการให้และยกเลิกสิทธิ์ไฟล์ด้วยสถานการณ์ Role ที่หลากหลาย
      - [ ] ทดสอบการบังคับใช้สิทธิ์ในการ Query ของผู้ดูแลระบบและการจัดการ Role
      - [ ] ทดสอบ Edge Case สำหรับการตรวจสอบสิทธิ์ (Role ที่ไม่มีอยู่, สิทธิ์ที่ไม่ถูกต้อง)
      - [ ] ทดสอบ Logic การสืบทอดสิทธิ์และลำดับขั้นของ Role
      - [ ] ทดสอบการจัดการข้อผิดพลาดของการบังคับใช้สิทธิ์และการจัดรูปแบบการตอบกลับ
      - [ ] ตรวจสอบให้แน่ใจว่าครอบคลุมทุกสถานการณ์ของสิทธิ์
  - [ ] สร้างรายงานและตรวจสอบความครอบคลุมของการทดสอบ (AC: 6)
      - [ ] ตั้งค่าการสร้างรายงาน Code Coverage ของ Bun พร้อมกำหนด Threshold ที่เหมาะสม
      - [ ] ตั้งค่าการรวบรวม Code Coverage สำหรับไฟล์ Source ทั้งหมด
      - [ ] ตั้งค่ารูปแบบการส่งออกรายงาน Coverage (text, HTML, JSON)
      - [ ] กำหนด Threshold ของ Coverage (80% สำหรับ Logic ทางธุรกิจ, 60% โดยรวม)
      - [ ] เพิ่มการตรวจสอบ Coverage ลงในขั้นตอนการพัฒนา
      - [ ] สร้างรายงาน Coverage ที่สามารถเข้าถึงได้สำหรับการ Code Review
      - [ ] จัดทำเอกสารข้อกำหนด Coverage และกระบวนการ Monitoring
      - [ ] ตรวจสอบให้แน่ใจว่ารายงาน Coverage ไม่รวมไฟล์ Test และไฟล์การตั้งค่า
  - [ ] เปิดใช้งานและบังคับใช้ TypeScript Strict Mode (AC: 7)
      - [ ] อัปเดต `tsconfig.json` เพื่อเปิดใช้งาน Strict Mode พร้อมตัวเลือก Strict ทั้งหมด
      - [ ] แก้ไขการละเมิด Strict Mode ของ TypeScript ทั้งหมดในโค้ด
      - [ ] ตรวจสอบให้แน่ใจว่าไม่มีการใช้ Type 'any' - ให้แทนที่ด้วย Type Definition ที่เหมาะสม
      - [ ] เปิดใช้งาน Strict Null Checks และจัดการทุกสถานการณ์ที่อาจเป็น Null/Undefined
      - [ ] เปิดใช้งาน Strict Function Types และแก้ไขปัญหา Signature ของฟังก์ชันทั้งหมด
      - [ ] เพิ่ม Type Definition ที่เหมาะสมสำหรับการใช้งาน Library ภายนอกทั้งหมด
      - [ ] ตรวจสอบให้แน่ใจว่า Import และ Export ทั้งหมดมี Type Annotation ที่เหมาะสม
      - [ ] ตั้งค่าการคอมไพล์ TypeScript ให้ล้มเหลวเมื่อมีข้อผิดพลาดด้าน Type
  - [ ] ตั้งค่า Linting และ Formatting ของโค้ดที่ครอบคลุม (AC: 8)
      - [ ] อัปเดตการตั้งค่า `biome.json` ด้วยกฎ Linting ที่ครอบคลุม
      - [ ] ตั้งค่ามาตรฐาน Formatting เพื่อให้โค้ดมี Style ที่สอดคล้องกัน
      - [ ] เปิดใช้งานกฎ Linting สำหรับแนวทางปฏิบัติที่ดีที่สุดของ TypeScript และข้อผิดพลาดที่อาจเกิดขึ้น
      - [ ] ตั้งค่าการจัดระเบียบ Import และการตรวจจับ Import ที่ไม่ได้ใช้งาน
      - [ ] ตั้งค่าการตรวจสอบ Formatting สำหรับไฟล์ TypeScript ทั้งหมด
      - [ ] ตั้งค่า Pre-commit Hook สำหรับการ Linting และ Formatting อัตโนมัติ
      - [ ] จัดทำเอกสารมาตรฐานคุณภาพโค้ดและการตั้งค่า Linting
      - [ ] ตรวจสอบให้แน่ใจว่ากฎ Linting สอดคล้องกับมาตรฐานการเขียนโค้ดจากเอกสารสถาปัตยกรรม
  - [ ] สร้างโครงสร้างพื้นฐานและเครื่องมือช่วยสำหรับการทดสอบที่ครอบคลุม (AC: 1-8)
      - [ ] สร้างเครื่องมือช่วยสำหรับการทดสอบที่ใช้ร่วมกันใน `src/shared/utils/test-helpers.ts`
      - [ ] สร้างเครื่องมือช่วยสำหรับการตั้งค่าและทำลายฐานข้อมูลสำหรับทดสอบ
      - [ ] สร้าง Mock Factory สำหรับสถานการณ์ข้อมูลสำหรับทดสอบทั่วไป
      - [ ] สร้างเครื่องมือช่วยสำหรับการยืนยัน (Assertion Helper) สำหรับรูปแบบการตรวจสอบทั่วไป
      - [ ] สร้างการตั้งค่าการทดสอบสำหรับสภาพแวดล้อมการทดสอบที่แตกต่างกัน
      - [ ] ตั้งค่าการทดสอบแบบ Parallelization และการเพิ่มประสิทธิภาพ
      - [ ] จัดทำเอกสารรูปแบบการทดสอบและแนวทางปฏิบัติที่ดีที่สุดสำหรับโค้ด
      - [ ] ตรวจสอบให้แน่ใจว่าโครงสร้างพื้นฐานการทดสอบรองรับข้อกำหนดการทดสอบทั้งหมด

## Dev Notes

### ข้อมูลเชิงลึกจาก Story ก่อนหน้า

Story 4.1-4.3 ได้จัดทำเอกสาร API, การจัดการข้อผิดพลาด และการตั้งค่า Production ที่ครอบคลุม ตอนนี้ระบบต้องการการทดสอบที่แข็งแกร่งและมาตรการคุณภาพของโค้ด เพื่อให้มั่นใจในความสามารถในการดูแลรักษาและความน่าเชื่อถือสำหรับการติดตั้งใน Production

### บริบททางสถาปัตยกรรมทางเทคนิค

**Testing Framework** [ที่มา: architecture/tech-stack.md]:

  - **Bun Test**: Framework การทดสอบในตัวพร้อมรองรับ TypeScript และการทำงานที่รวดเร็ว
  - **Mocking Library**: ฟังก์ชัน Mock ในตัวของ Bun สำหรับ Dependency ภายนอก
  - **Coverage Tool**: ระบบรายงาน Coverage ในตัวพร้อม Threshold ที่สามารถตั้งค่าได้
  - **TypeScript**: 5.3+ พร้อม Strict Mode เพื่อความปลอดภัยของ Type และคุณภาพของโค้ด

**Code Quality Tools** [ที่มา: architecture/tech-stack.md]:

  - **Biome.js**: 1.4+ เครื่องมือเดียวสำหรับ Linting และ Formatting ที่เร็วกว่า ESLint+Prettier
  - **TypeScript**: เปิดใช้งาน Strict Mode พร้อมการตรวจสอบ Type ที่ครอบคลุม
  - **Runtime**: Bun 1.0.21+ พร้อมการรองรับ TypeScript และประสิทธิภาพที่ยอดเยี่ยม

### กลยุทธ์และมาตรฐานการทดสอบ

**ปรัชญาการทดสอบ** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - **แนวทาง**: Test-After Development - เขียน Test หลังจาก Implement ฟีเจอร์เพื่อตรวจสอบพฤติกรรม
  - **เป้าหมาย Coverage**: 80% สำหรับ Logic ทางธุรกิจ, 60% สำหรับโปรเจกต์โดยรวม
  - **Test Pyramid**: เน้นหนักที่ Unit Test, ทดสอบ Integration น้อยที่สุด, และไม่มี E2E สำหรับ MVP

**การจัดระเบียบ Test** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **รูปแบบชื่อไฟล์**: ไฟล์ `*.test.ts` อยู่ร่วมกับไฟล์ต้นฉบับ
  - **ตำแหน่ง**: Tests อยู่คู่กับไฟล์ Source ในแต่ละ Directory ของ Feature/Provider
  - **Framework**: Bun Test (มีมาให้ในตัว) พร้อมรองรับ TypeScript
  - **Mocking**: ใช้ฟังก์ชัน Mock ในตัวของ Bun สำหรับ Dependency ภายนอก

### ตำแหน่งไฟล์และโครงสร้าง Test

**โครงสร้าง Source Tree** [ที่มา: architecture/source-tree.md]:

```
src/
├── features/                    # โมดูลฟีเจอร์ทางธุรกิจ
│   ├── auth/
│   │   ├── auth.middleware.ts
│   │   ├── auth.service.ts
│   │   └── __tests__/
│   │       ├── auth.middleware.test.ts
│   │       └── auth.service.test.ts
│   ├── files/
│   │   ├── files.routes.ts
│   │   ├── files.service.ts
│   │   ├── files.repository.ts
│   │   └── __tests__/
│   │       ├── files.service.test.ts
│   │       ├── files.repository.test.ts
│   │       └── files.routes.test.ts
│   └── [ฟีเจอร์อื่นๆ ที่ทำตามรูปแบบเดียวกัน]
├── providers/
│   ├── minio/
│   │   ├── minio.provider.ts
│   │   └── __tests__/
│   │       └── minio.provider.test.ts
│   └── [Provider อื่นๆ ที่ทำตามรูปแบบเดียวกัน]
└── shared/
    ├── middleware/
    │   └── __tests__/
    └── utils/
        └── test-helpers.ts
```

### ข้อกำหนดการทดสอบตามประเภทส่วนประกอบ

**การทดสอบ Service Layer**:

  - ทดสอบ Method ของ Logic ทางธุรกิจทั้งหมดด้วยสถานการณ์ Input ที่หลากหลาย
  - Mock Dependency ของ Repository และ Provider บริการภายนอก
  - ทดสอบการจัดการข้อผิดพลาดและสถานการณ์ Exception
  - ตรวจสอบการแปลงข้อมูลและการตรวจสอบข้อมูลที่ถูกต้อง
  - ทดสอบการทำงานแบบ Asynchronous และการจัดการ Promise
  - ตรวจสอบให้แน่ใจว่า Code Coverage ของทุก Class ของ Service มีอย่างน้อย 80%

**การทดสอบ Repository Layer**:

  - Mock Prisma Client โดยใช้ฟังก์ชัน Mock ในตัวของ Bun
  - ทดสอบการดำเนินการกับฐานข้อมูลโดยไม่ขึ้นกับฐานข้อมูลจริง
  - ทดสอบการจัดการ Transaction และสถานการณ์ Rollback
  - ทดสอบการจัดการการละเมิดข้อจำกัดและการแปลงข้อผิดพลาด
  - ทดสอบการสร้าง Query และการจัดการ Parameter
  - Mock การตอบกลับของฐานข้อมูลสำหรับสถานการณ์สำเร็จและล้มเหลวที่หลากหลาย

**การทดสอบ Route Layer**:

  - ทดสอบการจัดการ HTTP Method และการดึง Parameter ของ Route
  - ทดสอบการตรวจสอบคำขอโดยใช้ ElysiaJS Schema Validation
  - ทดสอบการจัดรูปแบบการตอบกลับและการจัดการรหัสสถานะ
  - Mock Dependency ของ Service Layer สำหรับการทดสอบ Route แบบแยกส่วน
  - ทดสอบข้อกำหนดด้านการยืนยันตัวตนและการอนุญาตสิทธิ์
  - ทดสอบการจัดการการตอบกลับข้อผิดพลาดและรูปแบบที่สอดคล้องกัน

**การทดสอบ Middleware**:

  - ทดสอบ Middleware การยืนยันตัวตนด้วยสถานการณ์ Header ที่หลากหลาย
  - ทดสอบ Logic การอนุญาตสิทธิ์ด้วยการผสมผสาน Role ที่แตกต่างกัน
  - ทดสอบการจัดการข้อผิดพลาดและการจัดรูปแบบการตอบกลับใน Middleware
  - ทดสอบการคงอยู่ของ Correlation ID ตลอดสายการทำงานของ Middleware
  - ทดสอบการทำงานร่วมกันของ Middleware และลำดับการทำงาน

### การตั้งค่า TypeScript Strict Mode

**ข้อกำหนด Strict Mode** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - **TypeScript Strict Mode โดยไม่มี Type 'any'**: โค้ดทั้งหมดต้องมี Type Definition ที่เหมาะสม
  - **ใช้ `unknown` สำหรับ Type ที่ไม่แน่นอน**: ใช้ `unknown` แทน `any` เพื่อความปลอดภัยของ Type
  - **กำหนด Type ให้ Import/Export ทั้งหมด**: ตรวจสอบให้แน่ใจว่าครอบคลุม Type อย่างสมบูรณ์ในทุกโมดูล

**การตั้งค่า TypeScript**:

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitReturns": true,
    "noImplicitThis": true,
    "noUncheckedIndexedAccess": true
  }
}
```

### มาตรฐานคุณภาพของโค้ด

**การตั้งค่า Biome.js** [ที่มา: architecture/coding-standards.md]:

  - การตั้งค่า Linting และ Formatting แบบรวมศูนย์ผ่าน `biome.json`
  - กฎ Linting เฉพาะสำหรับ TypeScript สำหรับแนวทางปฏิบัติที่ดีที่สุด
  - การจัดระเบียบ Import และการตรวจจับ Import ที่ไม่ได้ใช้งาน
  - มาตรฐาน Formatting ที่สอดคล้องกันในทุกไฟล์
  - Pre-commit Hook สำหรับการ Linting และ Formatting อัตโนมัติ

**กฎ Linting**:

  - ห้ามมี Console.log ใน Source Code (ให้ใช้ Pino Logger)
  - รูปแบบการจัดการข้อผิดพลาดและ Format ที่สอดคล้องกัน
  - การใช้ Async/Await และการจัดการ Promise ที่ถูกต้อง
  - แนวทางปฏิบัติที่ดีที่สุดของ TypeScript และการตรวจจับข้อผิดพลาดที่อาจเกิดขึ้น
  - การจัดระเบียบ Import และการจัดการ Dependency

### กลยุทธ์การ Mock

**การ Mock Dependency ภายนอก**:

  - **ฐานข้อมูล**: Mock การดำเนินการของ Prisma Client สำหรับ Unit Test แบบแยกส่วน
  - **MinIO**: Mock การตอบกลับของ MinIO Client สำหรับการทดสอบการดำเนินการกับไฟล์
  - **Redis**: Mock การดำเนินการของ Redis หากมีการใช้ฟังก์ชัน Redis
  - **External API**: Mock การเรียก API ภายนอกทั้งหมดเพื่อให้การทดสอบสามารถคาดเดาผลลัพธ์ได้

**รูปแบบการนำ Mock ไปใช้**:

  - ใช้ฟังก์ชัน Mock ในตัวของ Bun สำหรับแนวทางการ Mock ที่สอดคล้องกัน
  - สร้าง Mock Factory สำหรับสถานการณ์ข้อมูลสำหรับทดสอบทั่วไป
  - สร้างการตอบกลับ Mock ที่สมจริงซึ่งตรงกับพฤติกรรมจริงของบริการ
  - ทดสอบทั้งสถานการณ์สำเร็จและล้มเหลวด้วยการตอบกลับ Mock ที่เหมาะสม

### ข้อกำหนด Test Coverage

**Threshold ของ Coverage** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - **Logic ทางธุรกิจ**: 80% Code Coverage สำหรับ Class ของ Service และ Logic ทางธุรกิจ
  - **โปรเจกต์โดยรวม**: 60% Coverage สำหรับโปรเจกต์โดยรวม
  - **เส้นทางที่สำคัญ**: 100% Coverage สำหรับ Logic การยืนยันตัวตนและสิทธิ์
  - **การจัดการข้อผิดพลาด**: ครอบคลุมสถานการณ์ข้อผิดพลาดและเส้นทาง Exception ทั้งหมด

**การรายงาน Coverage**:

  - สร้างรายงาน Coverage แบบ HTML เพื่อการวิเคราะห์ Coverage ด้วยภาพ
  - รวมข้อมูล Coverage ใน CI/CD Pipeline สำหรับการตรวจสอบอัตโนมัติ
  - ไม่รวมไฟล์ Test, ไฟล์การตั้งค่า, และโค้ดที่สร้างขึ้นอัตโนมัติจาก Coverage
  - ตรวจสอบแนวโน้ม Coverage และป้องกัน Coverage Regression

### Technical Constraints

**มาตรฐานการทดสอบ** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - **การจัดระเบียบไฟล์ Test**: ทำตามรูปแบบ AAA (Arrange, Act, Assert)
  - **การทดสอบ Repository Pattern**: Logic ทางธุรกิจต้องไม่มีการเรียก Prisma โดยตรง
  - **การทดสอบ Provider Pattern**: การดำเนินการบริการภายนอกต้องผ่าน Class Provider
  - **การทดสอบการจัดการข้อผิดพลาด**: การตอบกลับข้อผิดพลาดทั้งหมดต้องเป็นไปตาม Schema ของ ErrorResponse

**ข้อกำหนดด้านประสิทธิภาพ**:

  - Unit Test ควรทำงานได้อย่างรวดเร็วโดยไม่มีการดำเนินการที่ใช้ทรัพยากรมาก
  - Mock Dependency ภายนอกเพื่อป้องกันการเรียก Network ระหว่างการทดสอบ
  - ทำการทดสอบแบบ Parallelization หากเป็นไปได้เพื่อให้ Feedback ที่รวดเร็วยิ่งขึ้น
  - ปรับการตั้งค่าและทำลายการทดสอบให้เหมาะสมเพื่อให้การทดสอบมีประสิทธิภาพ

**ข้อกำหนดการทดสอบความปลอดภัย**
**การทดสอบการยืนยันตัวตน**:

  - ทดสอบ Middleware การยืนยันตัวตนด้วยสถานการณ์ Header ของ Caddy ที่หลากหลาย
  - ทดสอบ Logic การอนุญาตสิทธิ์ด้วยการผสมผสาน Role ที่แตกต่างกัน
  - ทดสอบการตอบกลับข้อผิดพลาดด้านความปลอดภัยโดยไม่มีการเปิดเผยข้อมูลที่ละเอียดอ่อน
  - ทดสอบการตรวจสอบข้อมูลขาเข้าและการทำความสะอาดข้อมูลเพื่อหาช่องโหว่ด้านความปลอดภัย

**การทดสอบการปกป้องข้อมูล**:

  - ทดสอบว่าข้อมูลที่ละเอียดอ่อนไม่ปรากฏใน Log หรือการตอบกลับข้อผิดพลาด
  - ทดสอบว่าการตรวจสอบข้อมูลขาเข้าป้องกันการโจมตีแบบ Injection
  - ทดสอบว่าการตรวจสอบการอัปโหลดไฟล์ป้องกันการอัปโหลดไฟล์ที่เป็นอันตราย
  - ทดสอบว่า Correlation ID ไม่เปิดเผยข้อมูลที่ละเอียดอ่อน

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | สร้าง Story เริ่มต้นสำหรับการทดสอบ Unit Test และมาตรการคุณภาพของโค้ด | Scrum Master |
