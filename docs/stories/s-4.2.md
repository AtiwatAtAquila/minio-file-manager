# Story 4.2: การจัดการข้อผิดพลาดและการตรวจสอบข้อมูลที่ครอบคลุม

## สถานะ

แบบร่าง

## Story

**ในฐานะ** ผู้ใช้งาน API
**ฉันต้องการ** การจัดการข้อผิดพลาดและการตรวจสอบข้อมูลขาเข้าที่สอดคล้องกัน
**เพื่อที่จะ** ได้รับการแจ้งเตือนที่ชัดเจนเมื่อคำขอไม่สำเร็จหรือมีข้อมูลที่ไม่ถูกต้อง

## เกณฑ์การยอมรับ

1.  ทุก Endpoint ของ API มีรูปแบบการตอบกลับเมื่อเกิดข้อผิดพลาดที่สอดคล้องกัน พร้อมระบุรหัสข้อผิดพลาดและข้อความ
2.  มีการตรวจสอบข้อมูลขาเข้า (Input Validation) สำหรับข้อมูลในส่วน Body และ Query Parameter ของทุกคำขอ
3.  การตรวจสอบการอัปโหลดไฟล์ต้องครอบคลุมเรื่องขนาดไฟล์, ประเภทไฟล์ที่อนุญาต, และความปลอดภัยของชื่อไฟล์
4.  การละเมิดข้อจำกัดของฐานข้อมูล (Database Constraint) ต้องคืนค่าข้อความแจ้งข้อผิดพลาดที่เป็นมิตรต่อผู้ใช้งาน
5.  ข้อผิดพลาดจากบริการ MinIO ต้องถูกดักจับและคืนค่าเป็น HTTP 500 พร้อมคำแนะนำให้ลองใหม่อีกครั้ง
6.  มีการจัดการเรื่อง Rate Limiting อย่างเหมาะสม (หากมีการนำมาใช้) ด้วยรหัสสถานะ HTTP ที่ถูกต้อง
7.  ข้อผิดพลาดจากการตรวจสอบข้อมูลต้องคืนค่าเป็น HTTP 400 พร้อมรายละเอียดข้อผิดพลาดเฉพาะเจาะจงในแต่ละ Field
8.  ตัวจัดการข้อผิดพลาดหลัก (Global Error Handler) ต้องดักจับ Exception ที่ไม่ได้จัดการ และคืนค่าการตอบกลับข้อผิดพลาดที่ปลอดภัย

## งาน / งานย่อย

  - [ ] สร้าง Middleware สำหรับการจัดการข้อผิดพลาดหลัก (Global Error Handling) (AC: 1, 8)
      - [ ] สร้างไฟล์ `src/shared/middleware/error-handler.ts` พร้อมโค้ดสำหรับจัดการข้อผิดพลาดหลัก
      - [ ] ใช้ Schema การตอบกลับ ErrorResponse ที่สอดคล้องและมีการติดตาม Correlation ID
      - [ ] จัดการกับ Exception ที่ไม่ได้จัดการและคืนค่า HTTP 500 ที่ปลอดภัย
      - [ ] ตรวจสอบให้แน่ใจว่าการตอบกลับข้อผิดพลาดจะไม่เปิดเผยข้อมูลที่ละเอียดอ่อนของระบบ
      - [ ] นำตัวจัดการข้อผิดพลาดหลักไปใช้กับทุก Route ใน `src/app.ts`
      - [ ] ทำตามรูปแบบ ErrorResponse จากมาตรฐานการเขียนโค้ด พร้อมรหัสข้อผิดพลาดที่มีโครงสร้างชัดเจน
  - [ ] ปรับปรุงการตรวจสอบข้อมูลขาเข้าในทุก Endpoint (AC: 2, 7)
      - [ ] อัปเดตไฟล์ `src/features/files/files.validation.ts` ด้วย Schema การตรวจสอบไฟล์ที่ครอบคลุม
      - [ ] อัปเดตไฟล์ `src/features/roles/roles.validation.ts` ด้วยการตรวจสอบการสร้างและอัปเดต Role
      - [ ] อัปเดตไฟล์ `src/features/permissions/permissions.validation.ts` ด้วยการตรวจสอบการให้สิทธิ์
      - [ ] อัปเดตไฟล์ `src/features/admin/admin.validation.ts` ด้วยการตรวจสอบการ Query ของผู้ดูแลระบบ
      - [ ] ใส่รายละเอียดข้อผิดพลาดระดับ Field ในการตอบกลับเมื่อการตรวจสอบไม่สำเร็จ
      - [ ] ใช้ ElysiaJS Schema Validation สำหรับข้อมูลในส่วน Body และ Query Parameter ของทุกคำขอ
  - [ ] ตรวจสอบการอัปโหลดไฟล์แบบครอบคลุม (AC: 3)
      - [ ] เพิ่มการตรวจสอบขนาดไฟล์ พร้อมกำหนดขนาดสูงสุดที่สามารถตั้งค่าได้
      - [ ] ใช้การตรวจสอบประเภทไฟล์จาก Whitelist โดยใช้ MIME type
      - [ ] เพิ่มการตรวจสอบชื่อไฟล์เพื่อป้องกันการโจมตีแบบ Path Traversal และอักขระพิเศษ
      - [ ] ตรวจสอบสถานะการอัปโหลดไฟล์และป้องกันการเปลี่ยนสถานะที่ไม่ถูกต้อง
      - [ ] คืนค่าข้อความแจ้งข้อผิดพลาดที่เฉพาะเจาะจงสำหรับข้อผิดพลาดแต่ละประเภท
      - [ ] ตรวจสอบให้แน่ใจว่าการตรวจสอบนี้เกิดขึ้นก่อนการดำเนินการใดๆ กับ MinIO
  - [ ] ปรับปรุงการจัดการข้อผิดพลาดจากฐานข้อมูล (AC: 4)
      - [ ] อัปเดตไฟล์ Repository ด้วยการแปลงข้อผิดพลาดให้เป็นข้อความที่ผู้ใช้เข้าใจง่าย
      - [ ] จัดการกับข้อผิดพลาดที่เกิดจากการละเมิดข้อจำกัดของ Prisma (Unique Constraint, Foreign Key)
      - [ ] แปลงข้อผิดพลาดจากฐานข้อมูลให้เป็นข้อความทางธุรกิจที่เป็นมิตร
      - [ ] จัดการข้อผิดพลาดอย่างเหมาะสมในการทำ Transaction ของ Repository ทั้งหมด
      - [ ] ตรวจสอบให้แน่ใจว่าข้อผิดพลาดในการเชื่อมต่อฐานข้อมูลคืนค่ารหัสสถานะ HTTP ที่เหมาะสม
  - [ ] จัดการข้อผิดพลาดจากบริการ MinIO (AC: 5)
      - [ ] อัปเดตไฟล์ `src/providers/minio/minio.provider.ts` ด้วยการจัดการข้อผิดพลาดที่ครอบคลุม
      - [ ] ใช้ระบบ Retry Logic แบบ Exponential Backoff สำหรับข้อผิดพลาดชั่วคราวจาก MinIO
      - [ ] ดักจับข้อผิดพลาดในการเชื่อมต่อและการดำเนินการกับ MinIO พร้อมข้อความที่ผู้ใช้เข้าใจง่าย
      - [ ] คืนค่า HTTP 500 พร้อมคำแนะนำให้ลองใหม่อีกครั้งเมื่อ MinIO ไม่พร้อมใช้งาน
      - [ ] จัดการข้อผิดพลาดเมื่อเกิด Timeout จาก MinIO ด้วยการตอบกลับที่เหมาะสม
      - [ ] ตรวจสอบให้แน่ใจว่าข้อผิดพลาดจาก MinIO มี Correlation ID สำหรับการ Debug
  - [ ] จัดการข้อผิดพลาดจากการยืนยันตัวตนและการอนุญาตสิทธิ์ (AC: 1, 7)
      - [ ] ปรับปรุงไฟล์ `src/features/auth/auth.middleware.ts` ด้วยการตอบกลับข้อผิดพลาดที่มีรายละเอียด
      - [ ] คืนค่า HTTP 401 เมื่อ Header สำหรับการยืนยันตัวตนขาดหายไปหรือไม่ถูกต้อง
      - [ ] คืนค่า HTTP 403 เมื่อผู้ใช้มีสิทธิ์ไม่เพียงพอ พร้อมข้อความที่ชัดเจน
      - [ ] จัดการ Header ของ Caddy ที่มีรูปแบบไม่ถูกต้องด้วยรายละเอียดข้อผิดพลาด
      - [ ] ตรวจสอบให้แน่ใจว่าข้อผิดพลาดในการยืนยันตัวตนทั้งหมดเป็นไปตามรูปแบบ ErrorResponse ที่สอดคล้องกัน
  - [ ] สร้าง Unit Test ที่ครอบคลุมสำหรับการจัดการข้อผิดพลาด (AC: 1-8)
      - [ ] สร้างไฟล์ `src/shared/middleware/__tests__/error-handler.test.ts`
      - [ ] ทดสอบสถานการณ์ข้อผิดพลาดจากการตรวจสอบข้อมูลทั้งหมด พร้อมรายละเอียดระดับ Field
      - [ ] ทดสอบการจัดการข้อผิดพลาดจากการละเมิดข้อจำกัดของฐานข้อมูล
      - [ ] ทดสอบการจัดการข้อผิดพลาดจากบริการ MinIO และ Retry Logic
      - [ ] ทดสอบการตอบกลับข้อผิดพลาดจากการยืนยันตัวตนและการอนุญาตสิทธิ์
      - [ ] ทดสอบตัวจัดการข้อผิดพลาดหลักด้วย Exception ที่ไม่ได้จัดการ
      - [ ] ทดสอบความสอดคล้องของรูปแบบการตอบกลับข้อผิดพลาดในทุก Endpoint
      - [ ] ทดสอบการคงอยู่ของ Correlation ID ในทุกสถานการณ์ที่เกิดข้อผิดพลาด

## Dev Notes

### ข้อมูลเชิงลึกจาก Story ก่อนหน้า

Story 1.1-3.5 ได้สร้างฟังก์ชันหลักพร้อมการจัดการข้อผิดพลาดขั้นพื้นฐาน แต่การตรวจสอบและการจัดการข้อผิดพลาดที่ครอบคลุมจำเป็นต้องถูกกำหนดให้เป็นมาตรฐานในทุก Endpoint ระบบจำเป็นต้องมีการจัดการข้อผิดพลาดที่แข็งแกร่งเพื่อความพร้อมในการใช้งานจริง

### บริบททางสถาปัตยกรรมทางเทคนิค

**ElysiaJS Framework** [ที่มา: architecture/tech-stack.md]:

  - ElysiaJS 0.8+ พร้อมระบบ Schema Validation ในตัว
  - การตรวจสอบประเภทข้อมูลที่ปลอดภัยซึ่งสร้างการตอบกลับข้อผิดพลาดโดยอัตโนมัติ
  - ระบบ Global Middleware สำหรับการจัดการข้อผิดพลาดแบบรวมศูนย์
  - ความสามารถในการจัดรูปแบบการตอบกลับข้อผิดพลาดในตัว

**กลยุทธ์การจัดการข้อผิดพลาด** [ที่มา: architecture/error-handling-strategy.md]:

  - การตอบกลับข้อผิดพลาดที่มีโครงสร้างและรูปแบบที่สอดคล้องกันในทุก Endpoint
  - การใช้ Class-based Error ของ TypeScript พร้อมประเภทที่เจาะจงสำหรับข้อผิดพลาดแต่ละประเภท
  - การจัดการข้อผิดพลาดแบบรวมศูนย์พร้อมการแมปสถานะ HTTP ที่เหมาะสม
  - ข้อความแจ้งข้อผิดพลาดที่ปลอดภัยโดยไม่เปิดเผยรายละเอียดภายในของระบบ

### Data Models

**ErrorResponse Schema** [ที่มา: architecture/coding-standards.md\#critical-rules]:

```typescript
interface ErrorResponse {
  error: {
    code: string;           // รหัสข้อผิดพลาดที่มีโครงสร้าง: DOMAIN_OPERATION_REASON
    message: string;        // ข้อความแจ้งข้อผิดพลาดที่ผู้ใช้เข้าใจง่าย
    details?: unknown;      // รายละเอียดข้อผิดพลาดระดับ Field (ถ้ามี)
    correlationId: string;  // Correlation ID ของคำขอสำหรับ Debug
  };
}
```

**รายละเอียดข้อผิดพลาดจากการตรวจสอบข้อมูล (Validation)**:

```typescript
interface ValidationErrorDetails {
  field: string;
  value: unknown;
  message: string;
  constraint: string;
}
```

**รูปแบบรหัสข้อผิดพลาด** [ที่มา: architecture/error-handling-strategy.md]:

  - `FILE_UPLOAD_SIZE_EXCEEDED` - ขนาดไฟล์เกินขีดจำกัดสูงสุด
  - `FILE_TYPE_NOT_ALLOWED` - ประเภทไฟล์ไม่อยู่ใน Whitelist
  - `ROLE_ALREADY_EXISTS` - ชื่อ Role ซ้ำกัน
  - `PERMISSION_NOT_FOUND` - ไม่พบข้อมูลสิทธิ์
  - `AUTH_HEADER_MISSING` - Header สำหรับการยืนยันตัวตนที่จำเป็นขาดหายไป
  - `INSUFFICIENT_PERMISSIONS` - ผู้ใช้ไม่มี Role ที่จำเป็น

### File Locations

**โครงสร้าง Source Tree** [ที่มา: architecture/source-tree.md]:

  - **ตัวจัดการข้อผิดพลาดหลัก**: `src/shared/middleware/error-handler.ts`
  - **Schema การตรวจสอบข้อมูล**: ไฟล์ `src/features/*/validation.ts`
  - **การจัดการข้อผิดพลาดของ Provider**: ไฟล์ `src/providers/*/provider.ts`
  - **การจัดการข้อผิดพลาดของ Repository**: ไฟล์ `src/features/*/repository.ts`
  - **คลาสข้อผิดพลาดที่กำหนดเอง**: `src/shared/utils/errors.ts`

### ข้อกำหนดด้านความปลอดภัยและการตรวจสอบข้อมูล

**มาตรฐานการตรวจสอบข้อมูลขาเข้า** [ที่มา: architecture/security.md\#input-validation]:

  - ข้อมูลภายนอกทั้งหมดต้องถูกตรวจสอบที่ขอบเขตของ API โดยใช้ ElysiaJS Schema Decorators
  - ใช้แนวทาง Whitelist สำหรับประเภทไฟล์และชื่อ Role ด้วยการกำหนดรายการที่อนุญาตอย่างชัดเจน
  - การตรวจสอบจะป้องกันไม่ให้ข้อมูลที่มีรูปแบบไม่ถูกต้องถูกส่งต่อไปยัง Logic ทางธุรกิจ
  - ข้อผิดพลาดในการตรวจสอบระดับ Field ต้องมีข้อมูลข้อจำกัดที่เฉพาะเจาะจง

**ความปลอดภัยในการอัปโหลดไฟล์** [ที่มา: architecture/security.md]:

  - ขนาดไฟล์สูงสุดสามารถตั้งค่าได้ผ่าน Environment Variable
  - การตรวจสอบ MIME Type โดยใช้ Whitelist ของประเภทไฟล์ที่อนุญาต
  - การตรวจสอบความปลอดภัยของชื่อไฟล์เพื่อป้องกันการโจมตีแบบ Path Traversal
  - การทำความสะอาดอักขระพิเศษในชื่อไฟล์

**การจัดการข้อผิดพลาดในการยืนยันตัวตน** [ที่มา: architecture/security.md\#authentication-authorization]:

  - Header การยืนยันตัวตนที่ขาดหายไปจะคืนค่า HTTP 401 พร้อมข้อความที่ชัดเจน
  - สิทธิ์ของ Role ที่ไม่ถูกต้องจะคืนค่า HTTP 403 พร้อมรายละเอียดข้อกำหนดของ Role
  - Header ของ Caddy ที่มีรูปแบบไม่ถูกต้องจะคืนค่าข้อผิดพลาดจากการตรวจสอบข้อมูลที่เจาะจง
  - จะไม่มีการเปิดเผยข้อมูลที่ละเอียดอ่อนในการตอบกลับข้อผิดพลาดจากการยืนยันตัวตน

### การจัดการข้อผิดพลาดจากบริการภายนอก

**การจัดการข้อผิดพลาด MinIO** [ที่มา: architecture/error-handling-strategy.md]:

  - นโยบาย Retry ด้วย Exponential Backoff สำหรับการดำเนินการกับ MinIO (3 ครั้ง: หน่วงเวลา 1s, 2s, 4s)
  - การดำเนินการกับ MinIO จะ Timeout หลังจาก 30 วินาที พร้อมการตอบกลับข้อผิดพลาดที่เหมาะสม
  - ข้อผิดพลาดจากบริการภายนอกจะถูกแปลงเป็นข้อความที่ผู้ใช้เข้าใจง่ายโดยไม่มีรายละเอียดภายใน
  - มี Logic การชดเชยสำหรับ Operation ที่ล้มเหลว (เช่น ลบ Record ในฐานข้อมูลหาก MinIO ล้มเหลว)

**การจัดการข้อผิดพลาดจากฐานข้อมูล**:

  - ข้อผิดพลาดจากการละเมิดข้อจำกัดของ Prisma จะถูกแปลเป็นข้อความที่ผู้ใช้เข้าใจง่าย
  - มีการจัดการการ Rollback Transaction สำหรับการดำเนินการกับหลายตาราง
  - ข้อผิดพลาดในการเชื่อมต่อฐานข้อมูลจะคืนค่ารหัสสถานะ HTTP ที่เหมาะสม
  - ข้อผิดพลาดจาก Foreign Key จะให้บริบทความสัมพันธ์ที่ชัดเจน

### ข้อกำหนดการ Logging

**Structured Logging** [ที่มา: architecture/error-handling-strategy.md\#logging-standards]:

  - ใช้ Pino 8.17+ พร้อมรูปแบบการทำ Log แบบ JSON
  - Correlation ID (UUID v4 format: `req-{uuid}`) จะอยู่ใน Log ข้อผิดพลาดทั้งหมด
  - ข้อมูลผู้ใช้ (x-user-id) จะถูกรวมอยู่ใน Log ข้อผิดพลาดโดยไม่มีข้อมูลที่ละเอียดอ่อน
  - Log ข้อผิดพลาดจะรวมบริบทของบริการ: ชื่อบริการ, เวอร์ชัน, สภาพแวดล้อม

**ระดับและเนื้อหาของ Log**:

  - ใช้ระดับ ERROR สำหรับ Exception ที่ถูกดักจับและข้อผิดพลาดจากการตรวจสอบข้อมูลทั้งหมด
  - ใช้ระดับ WARN สำหรับปัญหาที่สามารถกู้คืนได้ (การพยายาม Retry, การทำงานสำรอง)
  - ห้าม Log ข้อมูลที่ละเอียดอ่อน (รหัสผ่าน, Token, เนื้อหาไฟล์)
  - ทำความสะอาดข้อมูลขาเข้าของผู้ใช้ใน Log เพื่อป้องกัน Log Injection

### Technical Constraints

**มาตรฐานการตอบกลับข้อผิดพลาด** [ที่มา: architecture/coding-standards.md\#critical-rules]:

  - การตอบกลับ API ทั้งหมดต้องใช้รูปแบบ ErrorResponse ที่สอดคล้องกัน
  - การจัดการข้อผิดพลาดต้องคง Correlation ID จากบริบทของคำขอไว้
  - การตรวจสอบข้อมูลขาเข้าเป็นสิ่งจำเป็นโดยใช้ Schema ของ ElysiaJS บนทุก Route ที่มีการป้องกัน
  - Repository Pattern ต้องไม่เปิดเผยข้อผิดพลาดจากฐานข้อมูลโดยตรงไปยังชั้น API

**ข้อกำหนดด้านประสิทธิภาพ**:

  - ข้อผิดพลาดจากการตรวจสอบข้อมูลควรล้มเหลวอย่างรวดเร็วโดยไม่มีการดำเนินการที่ใช้ทรัพยากรมาก
  - Retry Logic ของ MinIO ไม่ควรใช้เวลารวมเกิน 10 วินาที
  - การจัดการข้อผิดพลาดจากฐานข้อมูลไม่ควรเปิดเผยรายละเอียดการเชื่อมต่อ
  - ตัวจัดการข้อผิดพลาดหลักไม่ควรทำให้เกิดความล่าช้าอย่างมีนัยสำคัญ

### Testing

**Framework และตำแหน่งไฟล์** [ที่มา: architecture/test-strategy-and-standards.md\#test-types-and-organization]:

  - **Framework**: Bun Test (มีมาให้ในตัว) พร้อมรองรับ TypeScript
  - **รูปแบบชื่อไฟล์**: ไฟล์ `*.test.ts` อยู่ร่วมกับไฟล์ต้นฉบับ
  - **ตำแหน่ง**: Tests อยู่คู่กับไฟล์ Middleware, Validation, และ Provider

**ข้อกำหนดด้าน Coverage** [ที่มา: architecture/test-strategy-and-standards.md\#testing-philosophy]:

  - Code coverage 80% สำหรับ Middleware และ Logic การตรวจสอบข้อมูล
  - ทดสอบสถานการณ์ข้อผิดพลาดทั้งหมด รวมถึงกรณีพิเศษและ Race Condition
  - จำลองบริการภายนอก (MinIO, ฐานข้อมูล) สำหรับการทดสอบสภาวะข้อผิดพลาด

**ข้อกำหนด Test ที่เจาะจง**:

  - ทดสอบความสอดคล้องของรูปแบบ ErrorResponse ในข้อผิดพลาดทุกประเภท
  - ทดสอบรายละเอียดข้อผิดพลาดระดับ Field สำหรับ Schema การตรวจสอบข้อมูลทั้งหมด
  - ทดสอบการคงอยู่ของ Correlation ID ตลอดสายการจัดการข้อผิดพลาด
  - ทดสอบ Retry Logic ของ MinIO ในสถานการณ์ความล้มเหลวที่หลากหลาย
  - ทดสอบการจัดการข้อผิดพลาดจากการละเมิดข้อจำกัดของฐานข้อมูล
  - ทดสอบการตอบกลับข้อผิดพลาดจากการยืนยันตัวตนในสถานการณ์ Header ที่แตกต่างกัน
  - ทดสอบตัวจัดการข้อผิดพลาดหลักด้วยการจำลอง Exception ที่ไม่ได้จัดการ
  - ทดสอบการทำความสะอาดข้อความข้อผิดพลาดเพื่อป้องกันการเปิดเผยข้อมูลที่ละเอียดอ่อน

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | สร้าง Story เริ่มต้นสำหรับการจัดการข้อผิดพลาดและการตรวจสอบข้อมูลที่ครอบคลุม | Scrum Master |
