เนื่องจากข้อความต้นฉบับค่อนข้างยาวและมีข้อมูลเชิงเทคนิคเยอะมาก ผมจะปรับให้การแปลเป็นธรรมชาติเหมือนคนเขียน โดยคงเนื้อหาสำคัญไว้ครบถ้วนครับ

---

## เรื่องที่ 1.2: การออกแบบฐานข้อมูลและการตั้งค่า Prisma

**สถานะ:** พร้อมให้ตรวจสอบ

**เนื้อหาเรื่อง:**

**ในฐานะนักพัฒนา** ผมต้องการออกแบบฐานข้อมูลให้สมบูรณ์พร้อมตั้งค่า **Prisma ORM** เพื่อให้สามารถจัดการข้อมูล (เช่น ไฟล์, บทบาท, สิทธิ์การเข้าถึง) ได้อย่างปลอดภัยและมั่นใจในเรื่องของ Type-safety ครับ

### เกณฑ์การตรวจสอบความถูกต้อง

1.  ออกแบบ Schema ของ Prisma ให้มีตาราง **Files** (ประกอบด้วย id, filename, filetype, fileSize, uploadedAt, minioKey)
2.  Schema ของ Prisma มีตาราง **Roles** (ประกอบด้วย id, name, createdAt, updatedAt)
3.  Schema ของ Prisma มีตารางเชื่อมโยง **FileRolePermissions** (ประกอบด้วย fileId, roleName, grantedAt)
4.  สร้างและรันไฟล์ migration ของฐานข้อมูลได้สำเร็จ
5.  สร้าง Prisma client พร้อม TypeScript types สำหรับทุก Model
6.  ตั้งค่า Foreign key ของแต่ละตารางให้ถูกต้อง
7.  ตั้งค่าการเชื่อมต่อฐานข้อมูลผ่าน Environment variables
8.  สร้างสคริปต์ seed data เบื้องต้นสำหรับข้อมูลทดสอบ (เช่น บทบาท "Boss" และข้อมูลตัวอย่าง)

### งานหลัก / งานย่อย

- [x] ตั้งค่า Prisma Schema ด้วย Data Model ที่ถูกต้อง (ตามเกณฑ์ 1, 2, 3)
    - [x] กำหนด File model โดยใช้ UUID และมี field สำหรับ filename, filetype, fileSize, minioKey, uploadStatus, uploadedAt
    - [x] กำหนด Role model โดยใช้ UUID และมี field สำหรับ name, createdAt, updatedAt
    - [x] กำหนด FileRolePermission model โดยใช้ Composite Primary Key
    - [x] เพิ่ม Foreign key และตั้งค่า cascade deletes ที่เหมาะสม
    - [x] เพิ่ม indexes บนฐานข้อมูลเพื่อเพิ่มประสิทธิภาพ
- [x] ตั้งค่า Environment variables และการเชื่อมต่อฐานข้อมูล (ตามเกณฑ์ 7)
    - [x] เพิ่ม `DATABASE_URL` พร้อมตัวอย่าง connection string ของ PostgreSQL ลงในไฟล์ `.env.example`
    - [x] ตั้งค่า Prisma ให้ใช้ provider เป็น PostgreSQL
- [x] สร้างและรัน Database migrations (ตามเกณฑ์ 4)
    - [x] รันคำสั่ง `prisma migrate dev` เพื่อสร้าง migration แรก
    - [x] ตรวจสอบว่าไฟล์ migration ถูกสร้างขึ้นอย่างถูกต้อง
    - [x] ทดสอบการรันและ rollback migration
- [x] สร้าง Prisma client พร้อม TypeScript types (ตามเกณฑ์ 5)
    - [x] รันคำสั่ง `prisma generate` เพื่อสร้าง TypeScript client
    - [x] ตรวจสอบว่า type definitions ถูกสร้างขึ้นสำหรับทุก Model
    - [x] ทดสอบการสร้าง instance และการเชื่อมต่อ client
- [x] สร้างสคริปต์ Seed data สำหรับการพัฒนา (ตามเกณฑ์ 8)
    - [x] สร้างไฟล์ `prisma/seed.ts` พร้อมโค้ดสำหรับสร้างบทบาท "Boss"
    - [x] เพิ่มข้อมูลไฟล์และสิทธิ์ตัวอย่างสำหรับการทดสอบ
    - [x] ตั้งค่าคำสั่ง `prisma seed` ใน `package.json`
    - [x] ทดสอบการรัน seed script และยืนยันว่าข้อมูลถูกบันทึกในฐานข้อมูล
- [x] สร้างชุดทดสอบที่ครอบคลุม (ใช้กลยุทธ์ Test-First)
    - [x] เขียน Unit test สำหรับการตรวจสอบความถูกต้องของ database models
    - [x] เขียน Integration test สำหรับการทำงานของ Prisma client
    - [x] ทดสอบข้อจำกัดของ Foreign key และ cascade deletes
    - [x] ทดสอบ Unique constraints และประสิทธิภาพของ indexes

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 1.1 ได้สร้างโครงสร้างโปรเจกต์พื้นฐาน รวมถึงไฟล์ `package.json` และการตั้งค่า TypeScript ไว้เรียบร้อยแล้ว ทำให้พร้อมสำหรับการเชื่อมต่อฐานข้อมูล

#### Data Models ที่ใช้
* **File Model** [อ้างอิง: docs/architecture/data-models.md#file]:
    * **id:** UUID ที่เป็น Primary key
    * **filename:** String (ไม่เกิน 255 ตัวอักษร) พร้อมการตรวจสอบความถูกต้อง
    * **filetype:** String (ไม่เกิน 100 ตัวอักษร) สำหรับ MIME type
    * **fileSize:** BigInt สำหรับขนาดไฟล์
    * **minioKey:** String (ไม่เกิน 500 ตัวอักษร, ต้องไม่ซ้ำกัน) สำหรับจัดการไฟล์ใน MinIO
    * **uploadStatus:** Enum (PENDING, COMPLETED, FAILED) สำหรับสถานะการอัปโหลด
    * **uploadedAt:** DateTime พร้อมความละเอียด timestamp
    * **updatedAt:** DateTime สำหรับการตรวจสอบการแก้ไข
* **Role Model** [อ้างอิง: docs/architecture/data-models.md#role]:
    * **id:** UUID ที่เป็น Primary key สำหรับการจัดการบทบาท
    * **name:** String (ไม่เกิน 50 ตัวอักษร, ต้องไม่ซ้ำกัน)
    * **createdAt:** DateTime สำหรับการตรวจสอบ
    * **updatedAt:** DateTime สำหรับการติดตามการแก้ไข
* **FileRolePermission Model (ตารางเชื่อมโยง)** [อ้างอิง: docs/architecture/data-models.md#filerolepermission]:
    * **fileId:** UUID ที่เป็น Foreign key เชื่อมกับตาราง Files
    * **roleName:** String ที่เป็น Foreign key เชื่อมกับ `Roles.name` (ไม่ใช่ ID เพื่อความเข้ากันได้กับ Caddy header)
    * **grantedAt:** DateTime สำหรับบันทึกเวลาที่ให้สิทธิ์
    * **grantedBy:** String (ไม่เกิน 100 ตัวอักษร) สำหรับติดตาม User ID
    * ใช้ **Composite primary key** ที่ประกอบด้วย `[fileId, roleName]`

#### รายละเอียดของ Schema ฐานข้อมูล
* ใช้ PostgreSQL เป็นฐานข้อมูลหลัก
* **File model:** มีการทำ indexes บน `filename`, `uploadedAt`, `uploadStatus`
* **Role model:** มีการทำ index บน `name`
* **FileRolePermission:** มี Composite primary key และ indexes บน `roleName`, `grantedAt`, `grantedBy`
* ตั้งค่า **Cascade delete** เพื่อให้ข้อมูลมีความสอดคล้องกัน

#### การทดสอบ
* ใช้เฟรมเวิร์ก Bun Test
* **Integration tests** จะจำกัดอยู่แค่การทดสอบการเชื่อมต่อฐานข้อมูลโดยใช้ in-memory SQLite
* ไฟล์ test จะอยู่คู่กับไฟล์ต้นฉบับ โดยใช้ `.test.ts`
* ต้องมี **Code coverage** 80% สำหรับ business logic และ 60% สำหรับโปรเจกต์โดยรวม
