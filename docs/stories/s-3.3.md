---
## เรื่องที่ 3.3: ระบบจัดการสิทธิ์การเข้าถึงไฟล์

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะเจ้าของไฟล์หรือผู้ดูแลระบบ** ผมต้องการมอบและเพิกถอนสิทธิ์การเข้าถึงไฟล์ตามบทบาท (role-based) เพื่อให้ผมสามารถควบคุมได้ว่าผู้ใช้คนไหนสามารถดูและเข้าถึงไฟล์ไหนได้บ้าง

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **POST /files/{id}/permissions** สามารถมอบสิทธิ์ให้กับบทบาทหนึ่งสำหรับไฟล์หนึ่งได้
2.  Endpoint **DELETE /files/{id}/permissions/{roleName}** สามารถเพิกถอนสิทธิ์ของบทบาทสำหรับไฟล์นั้นได้
3.  Endpoint **GET /files/{id}/permissions** สามารถแสดงรายการบทบาททั้งหมดที่ได้รับสิทธิ์การเข้าถึงไฟล์นั้น
4.  การดำเนินการมอบสิทธิ์ต้องตรวจสอบว่าบทบาทเป้าหมายมีอยู่ในฐานข้อมูล
5.  การดำเนินการต้องตรวจสอบว่าไฟล์เป้าหมายมีอยู่จริง และผู้ใช้มีสิทธิ์ในการจัดการไฟล์นั้น
6.  ใช้หลักความปลอดภัยเป็นอันดับแรก: ไฟล์ใหม่จะไม่มีสิทธิ์การเข้าถึงใดๆ ยกเว้นบทบาทของผู้ที่อัปโหลดเท่านั้น
7.  ตาราง **FileRolePermissions** จะถูกอัปเดตด้วยความสัมพันธ์ foreign key ที่ถูกต้อง
8.  มีการบันทึกข้อมูลการตรวจสอบ (audit trail) ด้วย timestamp `grantedAt` เพื่อติดตามการมอบสิทธิ์

### งานหลัก / งานย่อย

- [ ] สร้างโครงสร้างสำหรับ validation และ types ของสิทธิ์ (เกณฑ์ 4, 5)
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.types.ts` พร้อม Domain types
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.validation.ts` พร้อม validation schemas
    - [ ] เขียนโค้ดตรวจสอบว่าบทบาทมีอยู่จริงโดยใช้ role repository
    - [ ] เขียนโค้ดตรวจสอบว่าไฟล์มีอยู่จริงและผู้ใช้มีสิทธิ์เข้าถึง
    - [ ] ใช้ ElysiaJS schema validation สำหรับการตรวจสอบ request/response
- [ ] สร้าง Repository สำหรับการดำเนินการกับฐานข้อมูล (เกณฑ์ 7, 8)
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.repository.ts` พร้อมการทำงานกับ Prisma
    - [ ] เขียนเมธอด `grantPermission()` สำหรับการสร้าง FileRolePermission
    - [ ] เขียนเมธอด `revokePermission()` พร้อมการจัดการ foreign key
    - [ ] เขียนเมธอด `getFilePermissions()` สำหรับแสดงรายการสิทธิ์
    - [ ] ใช้ Prisma transactions เพื่อให้การดำเนินการสอดคล้องกัน
    - [ ] เพิ่ม audit trail ด้วย timestamp `grantedAt` และ `grantedBy`
- [ ] สร้าง Business logic ในชั้น Service สำหรับสิทธิ์ (เกณฑ์ 1, 2, 3, 6)
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.service.ts` พร้อม Business logic
    - [ ] เขียนเมธอด `grantRoleAccess()` พร้อมการตรวจสอบความถูกต้องและความปลอดภัย
    - [ ] เขียนเมธอด `revokeRoleAccess()` พร้อมการจัดการที่เหมาะสม
    - [ ] เขียนเมธอด `getFilePermissions()` เพื่อส่งคืนรายการบทบาท
    - [ ] สร้างค่าเริ่มต้นสำหรับไฟล์ใหม่ให้มีความปลอดภัยเป็นอันดับแรก
    - [ ] จัดการข้อผิดพลาดจากฐานข้อมูลและส่งคืน HTTP status code ที่เหมาะสม
- [ ] สร้าง Endpoint REST API สำหรับสิทธิ์ (เกณฑ์ 1, 2, 3)
    - [ ] สร้างไฟล์ `src/features/permissions/permissions.routes.ts` พร้อม Endpoint ของ ElysiaJS
    - [ ] สร้าง Endpoint **POST /files/{id}/permissions** พร้อมตรวจสอบบทบาท
    - [ ] สร้าง Endpoint **DELETE /files/{id}/permissions/{roleName}**
    - [ ] สร้าง Endpoint **GET /files/{id}/permissions** สำหรับแสดงรายการสิทธิ์
    - [ ] นำ authentication middleware ไปใช้กับทุก Endpoint ที่เกี่ยวข้องกับสิทธิ์
    - [ ] ลงทะเบียน Routes ใน `src/app.ts` พร้อมการเชื่อมโยง Middleware ที่ถูกต้อง
- [ ] เชื่อมต่อระบบสิทธิ์เข้ากับกระบวนการอัปโหลดไฟล์ (เกณฑ์ 6)
    - [ ] แก้ไข Service การอัปโหลดไฟล์เพื่อตั้งค่าสิทธิ์เริ่มต้นสำหรับบทบาทของผู้ที่อัปโหลด
    - [ ] อัปเดต logic การสร้างไฟล์เพื่อสร้าง FileRolePermissions ตั้งแต่เริ่มต้น
    - [ ] ตรวจสอบให้แน่ใจว่าไฟล์ใหม่จะไม่มีสิทธิ์ใดๆ ยกเว้นบทบาทของผู้ที่อัปโหลด
    - [ ] ทดสอบการตั้งค่าสิทธิ์เริ่มต้นในระหว่างกระบวนการอัปโหลดไฟล์
- [ ] สร้าง Unit tests ที่ครอบคลุม (เกณฑ์ 1, 2, 3, 4, 5, 6, 7, 8)
    - [ ] สร้างไฟล์ `src/features/permissions/__tests__/permissions.service.test.ts`
    - [ ] สร้างไฟล์ `src/features/permissions/__tests__/permissions.repository.test.ts`
    - [ ] สร้างไฟล์ `src/features/permissions/__tests__/permissions.routes.test.ts`
    - [ ] ทดสอบการมอบและเพิกถอนสิทธิ์ที่สำเร็จ
    - [ ] ทดสอบการตรวจสอบว่าบทบาทและไฟล์มีอยู่จริง
    - [ ] ทดสอบการตรวจสอบสิทธิ์ของผู้ใช้ในการจัดการไฟล์
    - [ ] ทดสอบค่าเริ่มต้นที่เน้นความปลอดภัยสำหรับไฟล์ใหม่
    - [ ] ทดสอบ audit trail และ timestamp `grantedAt`
    - [ ] Mock Prisma client และ ElysiaJS request context สำหรับการทดสอบ

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า
งานที่ 3.1 และ 3.2 ได้สร้างการแยกวิเคราะห์ Header ของ Caddy และระบบจัดการบทบาทไว้แล้ว ทำให้เรามีข้อมูลผู้ใช้และ array ของบทบาทในทุก request พร้อมกับสามารถจัดการบทบาทต่างๆ ได้ งานนี้จะนำพื้นฐานเหล่านี้มาใช้เพื่อเชื่อมโยงไฟล์กับบทบาทต่างๆ

#### สถาปัตยกรรมทางเทคนิค
* **เฟรมเวิร์ก ElysiaJS:**
    * ใช้ ElysiaJS สำหรับสร้าง API, การตรวจสอบ Schema และ Middleware
    * ใช้ TypeScript สำหรับการตรวจสอบประเภทอย่างเข้มงวด
* **การจัดการฐานข้อมูล:**
    * ใช้ Repository pattern
    * **Prisma transactions** เป็นสิ่งจำเป็นสำหรับงานที่เกี่ยวข้องกับหลายตาราง
    * มีการจัดการการเข้าถึงพร้อมกัน (concurrent access)

### การทดสอบ
* **เฟรมเวิร์ก:** ใช้ **Bun Test**
* **ความครอบคลุมที่ต้องการ:**
    * 80% สำหรับโค้ดในส่วน service และ repository
    * Unit test สำหรับการทำงานกับสิทธิ์และ logic การตรวจสอบความถูกต้องทั้งหมด
* **การจำลองข้อมูล:** ใช้ Bun’s built-in mock สำหรับ Prisma client และ ElysiaJS context
* **รูปแบบการจัดเรียง Test:**
    * **Service tests:** `permissions.service.test.ts`
    * **Repository tests:** `permissions.repository.test.ts`
    * **Routes tests:** `permissions.routes.test.ts`
* **ข้อกำหนดการทดสอบเฉพาะ:**
    * ทดสอบการมอบและเพิกถอนสิทธิ์ที่สำเร็จ
    * ทดสอบการตรวจสอบว่าบทบาทและไฟล์มีอยู่จริง
    * ทดสอบการตรวจสอบสิทธิ์ของผู้ใช้ในการจัดการสิทธิ์
    * ทดสอบค่าเริ่มต้นที่เน้นความปลอดภัยในระหว่างการอัปโหลดไฟล์
    * ทดสอบ audit trail ด้วย `grantedAt` และ `grantedBy`
    * ทดสอบการจัดการข้อผิดพลาดสำหรับ request ที่ไม่ถูกต้องและข้อผิดพลาดจากฐานข้อมูล
    * Mock `UserContext` ด้วยการผสมผสานบทบาทที่แตกต่างกัน
