---
## เรื่องที่ 2.1: การจัดการข้อมูลไฟล์ (CRUD Operations)

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะนักพัฒนาที่ใช้งาน API** ผมต้องการสร้าง, อ่าน, อัปเดต, และลบข้อมูลไฟล์ เพื่อให้สามารถจัดการข้อมูลไฟล์ในฐานข้อมูลได้อย่างครบถ้วนทั้งก่อนและหลังการจัดการไฟล์ใน **MinIO**

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Endpoint **POST /files** สามารถสร้างข้อมูลไฟล์ในฐานข้อมูลได้ พร้อมตรวจสอบความถูกต้องของชื่อไฟล์และประเภทไฟล์
2.  Endpoint **GET /files/{id}** สามารถดึงข้อมูลไฟล์ทั้งหมดออกมาได้ รวมถึงสถานะการอัปโหลด
3.  Endpoint **PATCH /files/{id}** สามารถอัปเดตข้อมูลไฟล์บางส่วนได้ (เช่น filename, filetype) พร้อมตรวจสอบความถูกต้อง
4.  Endpoint **DELETE /files/{id}** สามารถลบข้อมูลไฟล์ออกจากฐานข้อมูลและสั่งให้ลบไฟล์ใน MinIO ด้วย
5.  ข้อมูลไฟล์ที่เก็บต้องประกอบด้วย: **id, filename, filetype, fileSize, uploadedAt, minioKey**
6.  การตรวจสอบข้อมูลที่เข้ามาต้องแน่ใจว่าชื่อไฟล์ปลอดภัยและประเภทไฟล์อยู่ในรายการที่อนุญาต
7.  การจัดการฐานข้อมูลต้องใช้ **Prisma** พร้อมระบบจัดการข้อผิดพลาดที่เหมาะสม
8.  ทุก Endpoint ต้องส่งคืนข้อมูลในรูปแบบ **JSON** ที่สอดคล้องกัน พร้อมกับ **HTTP status codes** ที่ถูกต้อง

### งานหลัก / งานย่อย

- [ ] สร้างประเภทข้อมูล (Domain Types) สำหรับไฟล์ (เกณฑ์ 5)
    - [x] กำหนด TypeScript interfaces สำหรับ File model
    - [x] สร้าง validation schemas สำหรับการทำงานที่เกี่ยวข้องกับไฟล์
    - [ ] กำหนดประเภทข้อผิดพลาด (error types) สำหรับการทำงานกับไฟล์
- [x] สร้างชั้น Repository สำหรับไฟล์ (เกณฑ์ 7)
    - [x] สร้างไฟล์ `files.repository.ts` สำหรับการทำงานกับ Prisma
    - [x] เขียนเมธอด `create`, `findById`, `update`, `delete`
    - [x] เพิ่มระบบจัดการข้อผิดพลาดและการรองรับ transaction
- [x] สร้าง Business logic ในชั้น Service สำหรับไฟล์ (เกณฑ์ 6, 7)
    - [x] สร้างไฟล์ `files.service.ts` พร้อมโค้ดสำหรับตรวจสอบความถูกต้อง
    - [x] เพิ่มโค้ดสำหรับจัดการชื่อไฟล์ให้ปลอดภัย
    - [x] เพิ่มการตรวจสอบประเภทไฟล์ตามรายการที่อนุญาต
    - [x] เพิ่มการตรวจสอบขนาดไฟล์
- [ ] สร้าง Endpoint REST API สำหรับไฟล์ (เกณฑ์ 1, 2, 3, 4, 8)
    - [x] สร้าง Endpoint **POST /files** พร้อมตรวจสอบข้อมูลที่เข้ามา
    - [ ] สร้าง Endpoint **GET /files/{id}** พร้อมระบบจัดการข้อผิดพลาดที่เหมาะสม
    - [ ] สร้าง Endpoint **PATCH /files/{id}** สำหรับการอัปเดตข้อมูลบางส่วน
    - [ ] สร้าง Endpoint **DELETE /files/{id}** พร้อมสั่งลบไฟล์ใน MinIO
    - [ ] ตั้งค่าการตรวจสอบ Schema ของ ElysiaJS สำหรับทุก Endpoint
- [ ] เพิ่ม Unit tests ที่ครอบคลุม (เกณฑ์ 7)
    - [ ] ทดสอบ `files.repository.ts` โดยใช้ Prisma client แบบ mock
    - [ ] ทดสอบ business logic ใน `files.service.ts`
    - [ ] ทดสอบ API endpoints ใน `files.routes.ts` โดยใช้ mock services
    - [ ] ให้มี Code coverage 80% สำหรับโค้ดที่เกี่ยวข้องกับไฟล์ทั้งหมด

---

### หมายเหตุจากนักพัฒนา

#### ข้อมูลเชิงลึกจากงานก่อนหน้า

งานที่ 1.4 ได้สร้างโครงสร้าง API ด้วย **ElysiaJS** พร้อมระบบ Health Check, Middleware และเอกสาร OpenAPI ไว้แล้ว ซึ่งเป็นรากฐานสำคัญสำหรับการสร้าง Endpoint ใหม่ๆ

#### โครงสร้าง Data Model ของไฟล์

- **`id`**: UUID - Primary key
- **`filename`**: String (ไม่เกิน 255 ตัวอักษร) - ชื่อไฟล์ที่ผู้ใช้ตั้ง
- **`filetype`**: String (ไม่เกิน 100 ตัวอักษร) - ประเภทไฟล์ (MIME type)
- **`fileSize`**: BigInt - ขนาดไฟล์เป็นไบต์
- **`uploadedAt`**: DateTime - เวลาที่อัปโหลดอัตโนมัติ
- **`minioKey`**: String (ไม่เกิน 500 ตัวอักษร) - Key เฉพาะสำหรับไฟล์ใน MinIO
- **`uploadStatus`**: Enum (PENDING, COMPLETED, FAILED) - สถานะการอัปโหลด

#### รายละเอียด API

- **Endpoint CRUD สำหรับไฟล์:**
  - **`GET /files/{id}`**: ดึงข้อมูลไฟล์ตาม ID พร้อมตรวจสอบสิทธิ์
  - **`POST /files`**: สร้างข้อมูลไฟล์ในฐานข้อมูล
  - **`PATCH /files/{id}`**: อัปเดตข้อมูลไฟล์
  - **`DELETE /files/{id}`**: ลบข้อมูลไฟล์และไฟล์ใน MinIO
- **ข้อกำหนดด้าน Authentication:**
  - ทุก Endpoint ต้องตรวจสอบ header ที่ส่งมาจาก Caddy (เช่น `x-user-id`, `x-user-email`, `x-user-roles`)
  - Middleware ที่ใช้ตรวจสอบสิทธิ์จะต้องทำงานก่อนการประมวลผลคำขอ

### การทดสอบ

- **เฟรมเวิร์ก:** ใช้ **Bun Test** ที่มีมาในตัว พร้อมรองรับ TypeScript
- **ความครอบคลุมที่ต้องการ:**
  - 80% สำหรับโค้ดในส่วน service และ business logic
  - มีการเขียน Unit test สำหรับทุกชั้น (repository, service, routes)
- **การจำลองข้อมูล:** ใช้ mock Prisma client สำหรับการทดสอบ repository และ mock services สำหรับการทดสอบชั้น service
- **รูปแบบการจัดเรียง Test:**
  - **Repository tests:** `files.repository.test.ts`
  - **Service tests:** `files.service.test.ts`
  - **Route tests:** `files.routes.test.ts`
  - ใช้รูปแบบ **AAA** (Arrange, Act, Assert) ในการเขียน test

---
