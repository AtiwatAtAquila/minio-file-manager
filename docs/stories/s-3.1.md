-----

## เรื่องที่ 3.1: การเชื่อมต่อ Header สำหรับการยืนยันตัวตนจาก Caddy

**สถานะ:** ฉบับร่าง

**เนื้อหาเรื่อง:**

**ในฐานะผู้รวมระบบ (system integrator)** ผมต้องการให้ API สามารถแยกวิเคราะห์และตรวจสอบข้อมูลผู้ใช้จาก **Header `forward_auth` ของ Caddy** เพื่อให้ระบบสามารถระบุตัวตนและบทบาทของผู้ใช้ได้โดยไม่ต้องทำระบบยืนยันตัวตนแยกต่างหาก

### เกณฑ์การตรวจสอบความถูกต้อง

1.  Middleware สามารถดึง Header `x-user-id`, `x-user-email`, และ `x-user-roles` จากทุก request ที่เข้ามา
2.  บทบาทของผู้ใช้ (roles) ที่อยู่ใน Header `x-user-roles` จะถูกแปลงจากรูปแบบ string ที่คั่นด้วยคอมมาให้เป็น Array
3.  หาก Header ที่จำเป็นหายไป จะต้องส่งคืน **HTTP 401** พร้อมข้อความแจ้งเตือนที่ชัดเจน
4.  หาก Header มีรูปแบบที่ไม่ถูกต้อง จะต้องส่งคืน **HTTP 400** พร้อมรายละเอียดของข้อผิดพลาด
5.  ข้อมูลผู้ใช้ (id, email, roles) จะถูกแนบไปกับ request object เพื่อให้ Route handler สามารถนำไปใช้งานต่อได้
6.  Middleware นี้จะต้องถูกนำไปใช้กับทุก Endpoint ที่ต้องมีการป้องกัน (ยกเว้น `/health` และ `/docs`)
7.  มี Unit test ครอบคลุมการแยกวิเคราะห์ Header, การตรวจสอบความถูกต้อง, และกรณีที่เกิดข้อผิดพลาด
8.  การเชื่อมต่อกับระบบ Middleware ของ ElysiaJS จะต้องทำอย่างสอดคล้องกัน

### งานหลัก / งานย่อย

  - [ ] สร้างโครงสร้าง Middleware สำหรับการยืนยันตัวตน (เกณฑ์ 1, 5, 6, 8)
      - [ ] สร้างไฟล์ `src/features/auth/auth.middleware.ts` สำหรับดึง Header ของ Caddy
      - [ ] สร้างไฟล์ `src/features/auth/auth.types.ts` เพื่อกำหนดประเภทข้อมูลสำหรับบริบทผู้ใช้
      - [ ] กำหนด interface `UserContext` สำหรับ id, email, roles
      - [ ] เขียน logic สำหรับตรวจสอบความถูกต้องของ Header
      - [ ] แนบข้อมูลผู้ใช้เข้ากับ request object เพื่อใช้ในส่วนอื่นๆ
  - [ ] เขียนโค้ดสำหรับแยกวิเคราะห์และตรวจสอบ Header (เกณฑ์ 2, 3, 4)
      - [ ] ดึง Header `x-user-id` และตรวจสอบว่าเป็น string ที่ไม่ว่างเปล่า
      - [ ] ดึง Header `x-user-email` และตรวจสอบว่าเป็นรูปแบบอีเมลที่ถูกต้อง
      - [ ] แปลง Header `x-user-roles` จาก string ที่คั่นด้วยคอมมาให้เป็น string array
      - [ ] ส่งคืน **HTTP 401** หาก Header ที่จำเป็นหายไป
      - [ ] ส่งคืน **HTTP 400** หาก Header มีรูปแบบที่ไม่ถูกต้อง พร้อมรายละเอียดข้อผิดพลาด
  - [ ] สร้าง Schema สำหรับการตรวจสอบความถูกต้อง (เกณฑ์ 4)
      - [ ] สร้างไฟล์ `src/features/auth/auth.validation.ts` พร้อม validation schemas สำหรับ Header
      - [ ] ใช้ ElysiaJS schema validation สำหรับตรวจสอบรูปแบบ Header
      - [ ] เพิ่มการตรวจสอบรูปแบบอีเมลสำหรับ `x-user-email`
      - [ ] เพิ่มการตรวจสอบชื่อบทบาทสำหรับ `x-user-roles`
  - [ ] นำ Middleware ไปใช้กับ Route ที่มีการป้องกัน (เกณฑ์ 6)
      - [ ] ลงทะเบียน middleware ใน `src/app.ts` สำหรับทุก Route ยกเว้น `/health` และ `/docs`
      - [ ] ตรวจสอบให้แน่ใจว่า middleware ทำงานก่อน route handler
      - [ ] ทดสอบว่า Endpoint `/health` และ `/docs` ยังคงเข้าถึงได้โดยไม่ต้องมีการยืนยันตัวตน
  - [ ] สร้าง Unit tests ที่ครอบคลุม (เกณฑ์ 7)
      - [ ] สร้างไฟล์ `src/features/auth/__tests__/auth.middleware.test.ts`
      - [ ] ทดสอบการดึง Header และการแยกวิเคราะห์ที่สำเร็จ
      - [ ] ทดสอบการส่งคืน **HTTP 401** เมื่อ Header หายไป
      - [ ] ทดสอบการส่งคืน **HTTP 400** เมื่อ Header มีรูปแบบที่ไม่ถูกต้อง
      - [ ] ทดสอบการแปลงบทบาทจาก string ที่คั่นด้วยคอมมา
      - [ ] ทดสอบการแนบข้อมูลผู้ใช้เข้ากับ request object

-----

### หมายเหตุจากนักพัฒนา

#### บริบททางสถาปัตยกรรม

  * **ระบบ Middleware ของ ElysiaJS:**
      * ElysiaJS มีระบบ middleware ในตัวสำหรับการประมวลผล request
      * Middleware สามารถใช้ได้กับทุก Route หรือเฉพาะกลุ่ม Route
      * สามารถเพิ่มคุณสมบัติที่กำหนดเองลงใน request context ได้
  * **รูปแบบการยืนยันตัวตน:**
      * Header `forward_auth` ของ Caddy จะมีข้อมูล `x-user-id`, `x-user-email`, และ `x-user-roles`
      * ทุก Endpoint ยกเว้น `/health` และ `/docs` ต้องมี Header เหล่านี้
      * ข้อมูลผู้ใช้ต้องพร้อมใช้งานใน route handler เพื่อใช้ในการตัดสินใจด้านสิทธิ์การเข้าถึง

#### Data Models

  * **`UserContext` Interface:**
    ```typescript
    interface UserContext {
        id: string; // จาก x-user-id header
        email: string; // จาก x-user-email header
        roles: string[]; // แปลงจาก x-user-roles header
    }
    ```

### การทดสอบ

  * **เฟรมเวิร์ก:** ใช้ **Bun Test** ที่มีมาในตัว
  * **ความครอบคลุมที่ต้องการ:**
      * 80% สำหรับโค้ดในส่วน middleware
      * ทดสอบการแยกวิเคราะห์ Header, การตรวจสอบความถูกต้อง, และการจัดการข้อผิดพลาด
      * ทดสอบทุกสถานการณ์การยืนยันตัวตนและกรณีพิเศษ
  * **รูปแบบการจัดเรียง Test:**
      * **Middleware tests:** `auth.middleware.test.ts`
      * ใช้รูปแบบ **AAA** (Arrange, Act, Assert)
  * **ข้อกำหนดการทดสอบเฉพาะ:**
      * ทดสอบการดึง Header ที่ถูกต้องและสำเร็จ
      * ทดสอบการส่งคืน **HTTP 401** เมื่อ Header หายไป
      * ทดสอบการส่งคืน **HTTP 400** เมื่อ Header มีรูปแบบที่ไม่ถูกต้อง
      * ทดสอบการแปลงบทบาทจาก string ที่คั่นด้วยคอมมา
      * ทดสอบการแนบข้อมูลผู้ใช้เข้ากับ request object
      * ทดสอบการใช้งาน middleware กับ Route ที่มีการป้องกันและที่ไม่มีการป้องกัน
